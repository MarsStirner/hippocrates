{% extends 'accounting/base.html' %}

{% block title %}> Приём платежей{% endblock %}

{% block main %}
<div ng-controller="CashBookCtrl" class="ng-cloak">
<section class="content-header">
    <h1>Приём платежей</h1>
</section>
<section class="content">
    <ng-form name="searchForm">
    <div class="box box-info">
    <div class="box-header with-border">
        <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label class="control-label" for="payer_search">Поиск плательщика</label>
                <div class="input-group">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
                    <input type="text" class="form-control" id="payer_search"
                        autocomplete="off" placeholder="Введите ФИО плательщика или наименование организации"
                        ng-change="payer.search_processed=false" ng-model="payer.query" wm-slow-change="performPayerSearch(payer.query)">
                    <span class="input-group-btn">
                        <button class="btn btn-danger" ng-click="clearPayerQuery()" title="Очистить поле">
                            <span class="glyphicon glyphicon-remove"></span>
                        </button>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="invoice_search">Поиск выставленного счёта</label>
                <div class="input-group">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
                    <input type="text" class="form-control" id="invoice_search"
                        autocomplete="off" placeholder="Введите номер счёта или данные плательщика"
                        ng-change="invoice.search_processed=false" ng-model="invoice.query" wm-slow-change="performInvoiceSearch(invoice.query)">
                    <span class="input-group-btn">
                        <button class="btn btn-danger" ng-click="clearInvoiceQuery()" title="Очистить поле">
                            <span class="glyphicon glyphicon-remove"></span>
                        </button>
                    </span>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="box-header with-border" ng-show="payer.search_result.length">
        <h3 class="box-title">Плательщики</h3>
    </div>
    <div class="box-body no-padding">
        <div ng-show="payer.query && payer.search_processed && !payer.search_result.length" class="alert alert-danger">
            Не найдены плательщики по введенному запросу
        </div>
        <div ng-show="payer.search_result.length" style="max-height: 300px;">
        <table class="table table-condensed table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <th>№</th>
                    <th>Плательщик</th>
                    <th>Тип</th>
                    <th>Договоры</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="payer in payer.search_result">
                    <td ng-bind="$index + 1"></td>
                    <td ng-bind="payer.short_descr"></td>
                    <td ng-bind="payer.ca_type.name"></td>
                    <td>
                        <ul>
                            <li ng-repeat="contract in payer.contract_list">
                                [[ contract.description.short ]]
                            </li>
                        </ul>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" ng-click="editPayerBalance($index)"
                            title="Пополнить баланс"><i class="fa fa-credit-card"></i></button>
                        <button type="button" class="btn btn-sm btn-default small-left-margin" ng-click="openPayerInvoices($index)"
                            title="Отобразить все счета плательщика"><i class="fa fa-list-alt"></i></button>
                    </td>
                </tr>
            </tbody>
        </table>
        </div>
    </div>

    <div class="box-header with-border" ng-show="invoice.search_result.length">
        <h3 class="box-title">Выставленные счета</h3>
    </div>
    <div class="box-body no-padding">
        <div ng-show="invoice.query && invoice.search_processed && !invoice.search_result.length" class="alert alert-danger">
            Не найдены счета по введенному запросу
        </div>
        <div ng-show="invoice.search_result.length" style="max-height: 300px; overflow-y: auto">
        <table class="table table-condensed table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <th>№</th>
                    <th>Номер</th>
                    <th>Дата формирования</th>
                    <th>Дата погашения</th>
                    <th>Сумма (руб.)</th>
                    <th>Договор/Плательщик</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="invoice in invoice.search_result">
                    <td ng-bind="$index + 1"></td>
                    <td ng-bind="invoice.number"></td>
                    <td ng-bind="invoice.set_date | asDate"></td>
                    <td>[[ invoice.settle_date | asDate ]] <i class="fa fa-check text-success" ng-show="isInvoiceClosed(invoice)"></i></td>
                    <td ng-bind="invoice.total_sum"></td>
                    <td>
                        <span>[[ invoice.contract.description.short ]]</span><br>
                        <span>[[ invoice.contract.payer.short_descr ]]</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary" ng-click="processInvoicePayment($index)"
                            ng-if="canProcessInvoicePayment(invoice)"
                            title="Оплатить счёт"><i class="fa fa-credit-card"></i></button>
                        <button type="button" class="btn btn-sm btn-primary" ng-click="processInvoiceCancel($index)"
                            ng-if="canProcessInvoiceCancel(invoice)"
                            title="Возврат"><i class="fa fa-reply"></i></button>
                    </td>
                </tr>
            </tbody>
        </table>
        </div>
    </div>

    </div>
    </ng-form>
</section>
</div>
{% endblock %}
{% block modules_js %}
    {{ super() }}
    <script src="{{ url_for('.static', filename='js/cashbook.js', v=app_version) }}"></script>
    <script src="{{ url_for('.static', filename='js/modal_cashbook.js', v=app_version) }}"></script>
{% endblock %}
