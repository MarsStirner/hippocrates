{% extends "event/base.html" %}
{% block main %}
<section class="content">
    <div ng-controller="EventListCtrl" class="ng-cloak">
    <div class="row">
        <div class="col-md-3">
            <!-- Filter -->
            <div>
                <div class="box box-primary">
                    <div class="box-header">
                        <h3 class="box-title">Фильтр</h3>
                    </div>
                    <div class="box-body">
                        <label for="filter-id">Идентификатор обращения</label>
                        <input class="form-control" id="filter-id" type="text" ng-model="flt.external_id" placeholder="Идентификатор">

                        <label for="filter-beg-date-from">Начато</label>
                        <div class="row">
                            <div class="col-md-6">
                                <wm-date id="filter-beg-date-from" ng-model="flt.beg_date_from"></wm-date>
                            </div>
                            <div class="col-md-6">
                                <wm-date id="filter-beg-date-to" ng-model="flt.beg_date_to"></wm-date>
                            </div>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" ng-model="flt.unfinished" ng-change="on_unfinished_changed()">Только незавершённые
                            </label>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" ng-model="flt.draft_contract">Только без договоров
                            </label>
                        </div>

                        <label for="filter-end-date">Завершено</label>
                        <div class="row">
                            <div class="col-md-6">
                                <wm-date id="filter-end-date-from" ng-model="flt.end_date_from" ng-disabled="flt.unfinished"></wm-date>
                            </div>
                            <div class="col-md-6">
                                <wm-date id="filter-end-date-to" ng-model="flt.end_date_to" ng-disabled="flt.unfinished"></wm-date>
                            </div>
                        </div>

                        <label for="filter-client">Пациент</label>
                        <ui-select id="filter-client" ng-model="flt.client" theme="select2">
                            <ui-select-match placeholder="ФИО пациента" allow-clear="true">[[ $select.selected.full_name ]]</ui-select-match>
                            <ui-select-choices repeat="client in clients" refresh="get_clients($select.search)">
                                <div>
                                    <small>[[ client.id ]]</small>
                                    <span ng-bind-html="client.full_name | highlight: $select.search"></span>
                                </div>
                                <div>
                                    <small>[[ client.birth_date | asDate ]], [[ client.sex.name ]]</small>
                                </div>
                            </ui-select-choices>
                        </ui-select>

                        <label for="filter-finance">Тип финансирования</label>
                        <rb-select id="filter-finance" ng-model="flt.finance_type" placeholder="Тип финансирования" ref-book="rbFinance"
                            allow-clear="true"></rb-select>

                        <label for="filter-request">Тип обращения</label>
                        <rb-select id="filter-request" ng-model="flt.request_type" placeholder="Тип обращения" ref-book="rbRequestType"
                            allow-clear="true"></rb-select>

                        <label for="filter-speciality">Специальность врача</label>
                        <rb-select id="filter-speciality" ng-model="flt.speciality" placeholder="Специальность врача" ref-book="rbSpeciality"
                            allow-clear="true"></rb-select>

                        <label for="filter-exec-person">Лечащий врач</label>
                        <wm-person-select id="filter-exec-person" ng-model="flt.exec_person" placeholder="Лечащий врач"></wm-person-select>

                        <label for="filter-result">Результат</label>
                        <rb-select id="filter-result" ng-model="flt.result" placeholder="Результат" ref-book="rbResult"
                            custom-name="rbResultFormatter" order-by="rbResultFormatter" allow-clear="true"></rb-select>

                        <label for="filter-org-struct">Подразделение</label>
                        <wm-custom-dropdown id="filter-org-struct">
                            <wm-org-structure-tree ng-model="flt.org_struct" nodes-selectable="true"></wm-org-structure-tree>
                        </wm-custom-dropdown>

                        <label for="filter-diag-mkb">МКБ диагноза</label>
                        <wm-mkb-multiple id="filter-diag-mkb" placeholder="Выберите диагнозы"
                            ng-model="flt.diag_mkb_list">
                        </wm-mkb-multiple>
                    </div>
                    <div class="box-footer">
                        <div class="btn-group">
                            <button class="btn btn-default" ng-click="get_data(1, true)">Получить данные</button>
                            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                <span class="caret"></span>
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <li><a ng-click="diurnal()">Незакрытые сегодня</a></li>
                                <li class="divider"></li>
                            </ul>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-default" ng-click="clear()">Сбросить</button>
                            <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                <span class="caret"></span>
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <li><a ng-click="clear_all()">Сбросить и очистить результаты</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="box box-primary">
            <!-- Main -->
            <table class="table table-condensed table-hover table-clickable">
                <thead wm-sortable-header>
                <tr>
                    <th width="10%" wm-sortable-column="external_id" on-change-order="sort_by_column(params)">№ обращения</th>
                    <th width="15%" wm-sortable-column="type_name" on-change-order="sort_by_column(params)">Тип</th>
                    <th width="10%" wm-sortable-column="beg_date" on-change-order="sort_by_column(params)">Начато</th>
                    <th width="10%" wm-sortable-column="end_date" on-change-order="sort_by_column(params)">Завершено</th>
                    <th width="20%" wm-sortable-column="client_full_name" on-change-order="sort_by_column(params)">Пациент</th>
                    <th width="15%" wm-sortable-column="person_short_name" on-change-order="sort_by_column(params)">Врач</th>
                    <th width="10%" wm-sortable-column="result_text" on-change-order="sort_by_column(params)">Результат</th>
                    <th width="10%">МКБ</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="event in results" ng-click="open_event(event.id)" ng-class="{'danger': event.contract.draft}">
                    <td>[[ event.external_id ]]</td>
                    <td>
                        <span ng-if="event.contract.draft" tooltip="Договор не заключен">[[ event.type_name ]]</span>
                        <span ng-if="!event.contract.draft">[[ event.type_name ]]</span>
                    </td>
                    <td>[[ event.beg_date | asDate ]]</td>
                    <td>[[ event.end_date | asDate ]]</td>
                    <td>[[ event.client_full_name ]]</td>
                    <td>[[ event.person_short_name ]]</td>
                    <td>[[ event.result_text ]]</td>
                    <td>
                        <span ng-repeat="item in event.diagnoses">
                            <span class="bottom_dashed" title="[[ item[1] ]]" ng-bind="item[0]"></span><span ng-if="!$last">, </span>
                        </span>
                    </td>
                </tr>
                </tbody>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-right">Всего записей: [[total]]</td>
                    </tr>
                </tbody>
            </table>
            <div class="box-footer center-block">
                <pagination page="page" ng-model="page" total-items="pages" items-per-page="1" max-size="max_size" ng-change="get_data(page)" ng-show="pages > 1" boundary-links="true"></pagination>
            </div>
            </div>
        </div>
{#    <pre>[[ flt | json ]]</pre>#}
    </div>
    </div>
</section>
{% endblock %}
{% block modules_js %}
    {{ super() }}
    <script src="{{ url_for('.static', filename='js/events.js', v=app_version) }}"></script>
{% endblock %}