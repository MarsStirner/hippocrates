{% extends "event/base.html" %}

{% block main %}
    <div ng-controller="EventInfoCtrl" class="ng-cloak">
        {% include "_breadcrumbs.html" %}
        <legend>
            <div class="pull-right text-right col-md-1">
                <ui-print-button ps="ps" resolve="ps_resolve()" ng-if="!event.is_new()"></ui-print-button>
            </div>
            <h2>
                {% if event and event.is_stationary %}История болезни №
                {% elif event and not event.is_stationary %}Обращение №
                {% elif not event and event.is_stationary %}Создание госпитализации
                {% elif not event and not event.is_stationary %}Создание обращения
                {% endif %}{{ event.externalId }}, пациент
                {% if user_profiles_mng.has_ui_registrator() %}
                <a href="{{ url_for('patients.patient', client_id=client_id) }}" tooltip="Редактирование регистрационной карты">
                    [[ event.info.client.info.full_name ]]
                </a>
                {% elif user_profiles_mng.has_ui_doctor() %}
                <a href="{{ url_for('patients.patient_info_full', client_id=client_id) }}" tooltip="Просмотр регистрационной карты">
                    [[ event.info.client.info.full_name ]]
                </a>
                {% else %}[[ event.info.client.info.full_name ]]{% endif %}
            </h2>
        </legend>
        <div class="row">
            <div class="col-md-2 affix-holder">
                <div class="toc-affix" bs-affix>
                    <toc-affix toc-name="tocEventForm">
                    <hr>
                    {% if not event or (event.is_closed and user_profiles_mng.has_ui_registrator()) or (
                        not event.is_closed and (
                            user_utils.can_edit_event(event) or user_utils.can_edit_event_payment_info(event)
                        )) %}
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" ng-click="save_event()" class="btn btn-block btn-success"
                            ng-bind="event.is_new() ? 'Создать' : 'Сохранить'">Создать</button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" ng-click="cancel_editing()" class="btn btn-block btn-default">Отмена</button>
                        </div>
                    </div>
                    {%- endif %}
                    {% if user_utils.can_close_event(event) %}
                    <div class="row vmargin10">
                        <div class="col-md-12">
                            <button type="button" ng-click="close_event()" class="btn btn-block btn-info">Закрыть обращение</button>
                        </div>
                    </div>
                    {%- endif %}
                    {% if event.is_closed %}
                    <div class="row vmargin10">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-block btn-gray disabled">Обращение закрыто</button>
                        </div>
                    </div>
                    {%- endif %}
                    {% if user_utils.can_delete_event(event) %}
                    <div class="row vmargin10">
                        <div class="col-md-12">
                            <button type="button" ng-click="delete_event()" class="btn btn-block btn-danger"
                                    ng-if="btn_delete_event_visible()">Удалить обращение</button>
                        </div>
                    </div>
                    {% endif %}
                    </toc-affix>
                </div>
            </div>
            <div class="col-md-10">
                <div ui-alert-list="alerts"></div>
                <div class="marginal">
                    <ng-form name="eventForm" id="eventForm" role="form" novalidate
                             toc-element toc-name="tocEventForm" form-safe-close>
                        <wm-client-info client="event.info.client"></wm-client-info>
                        {% if event and event.is_stationary %}
                            {% include "event/_stationary_info.html" %}
                        {% endif %}
                        {% include "event/_main_info.html" %}
                        {% if user_profiles_mng.has_ui_doctor() and user_utils.can_read_dignoses(event) %}
                            {% include "event/_diagnoses.html" %}
                        {% endif %}
                        {% if user_profiles_mng.has_ui_registrator() or user_profiles_mng.has_ui_cashier() %}
                            {% include "event/_services.html" %}
                            {% include "event/_payment.html" %}
                        {% endif %}
                        {% if user_utils.can_read_actions_meddoc(event) %}
                            <div class="marginal">
                                <ng-form name="eventMedDocActionsForm" toc-element="Медицинские документы">
                                    <legend>Медицинские документы</legend>
                                    <wm-action-list event="event" action-type-group="medical_documents"></wm-action-list>
                                </ng-form>
                            </div>
                        {% endif %}
                        {% if user_utils.can_read_actions_diagnostic(event) %}
                            <div class="marginal">
                                <ng-form name="eventDiagActionsForm" toc-element="Диагностика">
                                    <legend>Диагностика</legend>
                                    <wm-action-list event="event" action-type-group="diagnostics"></wm-action-list>
                                </ng-form>
                            </div>
                        {% endif %}
                        {% if user_utils.can_read_actions_lab(event) %}
                            <div class="marginal">
                                <ng-form name="eventLabActionsForm" toc-element="Лаб.исследования">
                                    <legend>Лаб.исследования</legend>
                                    <wm-action-list event="event" action-type-group="lab"></wm-action-list>
                                </ng-form>
                            </div>
                        {% endif %}
                        {% if user_utils.can_read_actions_treatment(event) %}
                            <div class="marginal">
                                <ng-form name="eventCureActionsForm" toc-element="Лечение">
                                    <legend>Лечение</legend>
                                    <wm-action-list event="event" action-type-group="treatments"></wm-action-list>
                                </ng-form>
                            </div>
                        {% endif %}
                    </ng-form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block modules_js %}
    {{ super() }}
    <script src="{{ url_for('.static', filename='js/event.js', v=app_version) }}"></script>
    <script src="{{ url_for('static', filename='js/services/event/event-services.js', v=nemesis_version) }}"></script>
    <script src="{{ url_for('.static', filename='js/directives.js', v=app_version) }}"></script>
    <script type="text/ng-template" id="modal-prev-event-contract.html">{% include "event/_modal_prev_event_contracts.html" %}</script>
    <script type="text/ng-template" id="modal-relatives.html">{% include "event/_modal_relatives.html" %}</script>
    <script type="text/ng-template" id="modal-switch-payer.html">{% include "event/_modal_switch_payer_tab.html" %}</script>
{% endblock %}