<header class="main-header" ng-controller="WebMisHeader">
    <a class="logo" href="{{ url_for('index') }}">
      <!-- mini logo for sidebar mini 50x50 pixels -->
      <span class="logo-mini"><b>MIS</b></span>
      <!-- logo for regular state and mobile devices -->
      <span class="logo-lg"><b>Web</b>MIS</span>
    </a>
    {%- if current_user.id and current_user.current_role -%}
    <nav class="navbar navbar-static-top" role="navigation">
        <a role="button" data-toggle="offcanvas" class="sidebar-toggle" href="#">
            <span class="sr-only">Toggle navigation</span>
        </a>
        <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
              <!-- Messages: style can be found in dropdown.less-->
              <li class="messages-menu">
                <!-- Menu toggle button -->
                <a href="{{ url_for('useraccount.index_html') }}">
                  <i class="fa fa-envelope-o"></i>
                  <span class="label label-success" ng-if="unread > 0" ng-bind="unread"></span>
                </a>
              </li><!-- /.messages-menu -->

              <!-- Notifications Menu -->
{#              <li class="dropdown notifications-menu">#}
{#                <!-- Menu toggle button -->#}
{#                <a href="#" class="dropdown-toggle" data-toggle="dropdown">#}
{#                  <i class="fa fa-bell-o"></i>#}
{#                  <span class="label label-warning">10</span>#}
{#                </a>#}
{#                <ul class="dropdown-menu">#}
{#                  <li class="header">You have 10 notifications</li>#}
{#                  <li>#}
{#                    <!-- Inner Menu: contains the notifications -->#}
{#                    <ul class="menu">#}
{#                      <li><!-- start notification -->#}
{#                        <a href="#">#}
{#                          <i class="fa fa-users text-aqua"></i> 5 new members joined today#}
{#                        </a>#}
{#                      </li><!-- end notification -->#}
{#                    </ul>#}
{#                  </li>#}
{#                  <li class="footer"><a href="#">View all</a></li>#}
{#                </ul>#}
{#              </li>#}
              <!-- Tasks Menu -->
{#              <li class="dropdown tasks-menu">#}
{#                <!-- Menu Toggle Button -->#}
{#                <a href="#" class="dropdown-toggle" data-toggle="dropdown">#}
{#                  <i class="fa fa-flag-o"></i>#}
{#                  <span class="label label-danger">9</span>#}
{#                </a>#}
{#                <ul class="dropdown-menu">#}
{#                  <li class="header">You have 9 tasks</li>#}
{#                  <li>#}
{#                    <!-- Inner menu: contains the tasks -->#}
{#                    <ul class="menu">#}
{#                      <li><!-- Task item -->#}
{#                        <a href="#">#}
{#                          <!-- Task title and progress text -->#}
{#                          <h3>#}
{#                            Design some buttons#}
{#                            <small class="pull-right">20%</small>#}
{#                          </h3>#}
{#                          <!-- The progress bar -->#}
{#                          <div class="progress xs">#}
{#                            <!-- Change the css width attribute to simulate progress -->#}
{#                            <div class="progress-bar progress-bar-aqua" style="width: 20%" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">#}
{#                              <span class="sr-only">20% Complete</span>#}
{#                            </div>#}
{#                          </div>#}
{#                        </a>#}
{#                      </li><!-- end task item -->#}
{#                    </ul>#}
{#                  </li>#}
{#                  <li class="footer">#}
{#                    <a href="#">View all tasks</a>#}
{#                  </li>#}
{#                </ul>#}
{#              </li>#}
              <!-- User Account Menu -->
              <li class="dropdown user user-menu">
                <!-- Menu Toggle Button -->
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <!-- The user image in the navbar-->
                    <span class="img-circle glyphicon glyphicon-user"></span>
                  <!-- hidden-xs hides the username on small devices so only the image appears. -->
                  <span class="hidden-xs">{{ current_user.format_name() }}</span>
                </a>
                <ul class="dropdown-menu">
                  <!-- The user image in the menu -->
                  <li class="user-header">
                    <h1 class="img-circle glyphicon glyphicon-user text-white"></h1>
                    <p>
                      {{ current_user.format_name() }}
                        {% if user_profiles_mng.has_ui_assistant() %}
                        <small>ассистирую:</small>
                        {% if current_user.master %}
                            <a class="show_assist" id="current_assist" href="javascript:void(0);">
                            <span class="fa fa-user-md assist-icon"></span> {{ current_user.master.format_name(is_master=True) }}
                            </a>
                            <script type="application/javascript">
                                $(function () {
                                    $(".show_assist").popover({
                                        html : true,
                                        placement : 'left',
                                        title : '',
                                        trigger : 'focus',
                                        container: 'body',
                                        content: function() {
                                          return $('#assist').html();
                                        }
                                    });
                                });
                            </script>
                            <div id="assist" class="hidden">
                                <div class="row">
                                  <div class="col-xs-4">
                                    <span class="thumbnail novmargin"><span style="font-size:66px" class="fa fa-user-md assist-icon text-muted"></span></span>
                                  </div>
                                  <div class="col-xs-8">
                                    <h4>{{ current_user.master.lastName }} {{ current_user.master.firstName|truncate(1, True, end=".") }} {{ current_user.master.patrName|truncate(1, True, end=".") }}
                                      <small>{{ current_user.master.speciality or '' }}</small><br>
                                      <small>{{ current_user.master._current_role_name }}</small>
                                    </h4>
                                  </div>
                                  <div class="col-xs-12">
                                      <h4 class="vmargin10">
{#                                      <hr class="vmargin10">#}
                                      <small>{{ current_user.master.org_structure.name }}</small>
                                      </h4>
                                      <button id="change_assist"  onclick="location.href='{{ url_for('doctor_to_assist', next=request.url) }}'" class="btn btn-primary btn-sm btn-block">Сменить врача</button>
                                  </div>
                                </div>
                            </div>
                            {% else %}
                                <a class="show_assist" href="{{ url_for('doctor_to_assist', next=request.url) }}" title="Выбрать врача"><span class="fa fa-user-md assist-icon"></span> не выбрано</a>
                            {% endif %}
                        {% endif %}
                    </p>
                  </li>
                  <!-- Menu Body -->
                  <li class="user-body">
                    <div class="col-xs-12 text-center">
                      {% if current_user.roles | length > 1 %}
                        <form id="_change_role_frm" action="{{ url_for('select_role') }}" method="POST">
                            <select name="roles" onchange="$('#_change_role_frm').submit();" class="form-control">
                            {% for code, name in current_user.roles -%}
                                <option value="{{ code }}"{%- if code == current_user.current_role %} selected="selected"{% endif -%}>{{ name }}</option>
                            {%- endfor -%}
                            </select>
                        </form>
                        {% endif %}
                    </div>
                  </li>
                  <!-- Menu Footer-->
                  <li class="user-footer">
                    <div class="pull-left">
                      <a href="{{ url_for('useraccount.index_html') }}" class="btn btn-default btn-flat">Личный кабинет</a>
                    </div>
                    <div class="pull-right">
                      <a id="logout" href="{{ url_for('logout') }}" title="Выйти" class="btn btn-default btn-flat">Выход</a>
                    </div>
                  </li>
                </ul>
              </li>
              <!-- Control Sidebar Toggle Button -->
{#              <li>#}
{#                <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>#}
{#              </li>#}
            </ul>
        </div>
    </nav>
        <script>
        $(function(){
            $('.dropdown-menu input, .dropdown-menu select, a#current_assist').click(function(e) {
                e.stopPropagation();
            });
        });
        </script>
    {%- endif -%}
</header>
<script language="JavaScript">
    WebMisHeader = function ($scope, UserMail) {
        $scope.unread = 0;
        $scope.messages = [];
        UserMail.subscribe('unread', function (result) {
            $scope.unread = result.unread;
            $scope.messages = result.messages;
        });
    }
</script>