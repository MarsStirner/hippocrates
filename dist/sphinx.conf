#
# Minimal Sphinx configuration sample (clean, simple, functional)
#

source person
{
    type        = mysql

    sql_host    = %DB_HOST%
    sql_user    = %DB_USER%
    sql_pass    = %DB_PASSWORD%
    sql_db      = %DB_NAME%
    sql_port    = %DB_PORT%

#   sql_query_pre = SET CHARACTER_SET_RESULTS=utf8
    sql_query_pre = SET NAMES utf8
    sql_query_pre = SET CHARACTER SET utf8

    sql_query       = \
        SELECT p.id, p.org_id, p.lastName, p.firstName, p.patrName, \
            s.id as speciality_id, s.name as speciality, s.code as speciality_code, s.OKSOName, \
            os.id as orgStructure_id, os.code as orgStructure_code, os.name as orgStructure \
        FROM Person p LEFT JOIN rbSpeciality s ON p.speciality_id = s.id \
        LEFT JOIN OrgStructure os ON p.orgStructure_id = os.id \
        WHERE p.deleted=0

    sql_attr_uint       = org_id
    sql_field_string    = lastName
    sql_field_string    = firstName
    sql_field_string    = patrName
    sql_attr_uint   = speciality_id
    sql_attr_string = speciality_code
    sql_field_string    = speciality
    sql_attr_uint   = orgStructure_id
    sql_attr_string = orgStructure_code
    sql_attr_string = orgStructure

    sql_query_info      = SELECT * FROM Person WHERE id=$id
}


index person
{
    source          = person
    path            = /var/lib/sphinxsearch/data/person
    docinfo         = extern
    charset_type        = utf-8
    min_word_len        = 2
    min_prefix_len      = 2

    # default are English and Russian letters
#   charset_table = 0..9, A..Z->a..z, _, a..z, \
#       U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+451, U+451

#   morphology      = stem_enru
#   enable_star     = 1
}

source patient
{
        type        = mysql

        sql_host    = %DB_HOST%
        sql_user    = %DB_USER%
        sql_pass    = %DB_PASSWORD%
        sql_db      = %DB_NAME%
        sql_port    = %DB_PORT%

#       sql_query_pre = SET CHARACTER_SET_RESULTS=utf8
        sql_query_pre = SET NAMES utf8
        sql_query_pre = SET CHARACTER SET utf8

        sql_query               = \
                SELECT c.id as id, CAST(c.id AS CHAR) as code, c.lastName, c.firstName, c.patrName, c.SNILS, DATE_FORMAT(c.birthDate, '%d.%m.%Y') as birthDate_f1, DATE_FORMAT(c.birthDate, '%e.%m.%Y') as birthDate_f2, \
                GROUP_CONCAT(CONCAT_WS(' ', cd.serial, cd.number) SEPARATOR '; ') as document, \
                GROUP_CONCAT(CONCAT_WS(' ', cp.serial, cp.number) SEPARATOR '; ') as policy \
                FROM Client c \
                LEFT JOIN ClientDocument cd ON cd.client_id=c.id \
                LEFT JOIN ClientPolicy cp ON cp.client_id=c.id \
                GROUP BY c.id

        sql_field_string        = code
        sql_field_string        = lastName
        sql_field_string        = firstName
        sql_field_string        = patrName
        sql_query_info          = SELECT * FROM Client WHERE id=$id
}


index patient
{
        source                  = patient
        path                    = /var/lib/sphinxsearch/data/patient
        docinfo                 = extern
        charset_type            = utf-8
        min_word_len            = 2
        min_prefix_len           = 2

        ignore_chars = U+2E
        charset_table = 0..9, A..Z->a..z, _, a..z,  \
           U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+451, U+451

#       morphology              = stem_enru
#       enable_star             = 1
}

#index testrt
#{
#   type            = rt
#   rt_mem_limit        = 32M
#
#   path            = /var/lib/sphinxsearch/data/testrt
#   charset_type        = utf-8
#
#   rt_field        = title
#   rt_field        = content
#   rt_attr_uint        = gid
#}


source event_service
{
        type        = mysql

        sql_host    = %DB_HOST%
        sql_user    = %DB_USER%
        sql_pass    = %DB_PASSWORD%
        sql_db      = %DB_NAME%
        sql_port    = %DB_PORT%

#       sql_query_pre = SET CHARACTER_SET_RESULTS=utf8
        sql_query_pre = SET NAMES utf8
        sql_query_pre = SET CHARACTER SET utf8

        sql_query_pre = SET @a := 1;
        sql_query               = \
                SELECT  @a := @a + 1 AS id, at.id as action_type_id, ct.code, ct.name as service, at.name, at.service_id, \
                    GROUP_CONCAT(DISTINCT e.eventType_id SEPARATOR ',') as eventType_id, \
                    IF(e.speciality_id, GROUP_CONCAT(DISTINCT e.speciality_id SEPARATOR ','), 0) as speciality_id, \
                    GROUP_CONCAT(DISTINCT ct.master_id SEPARATOR ',') as contract_id, \
                    ct.price \
                FROM ActionType at \
                INNER JOIN EventType_Action e ON e.actionType_id=at.id \
                INNER JOIN Contract_Tariff ct ON ct.service_id=at.service_id AND ct.eventType_id=e.eventType_id \
                INNER JOIN Contract c ON ct.master_id=c.id \
                INNER JOIN rbService s ON s.id=at.service_id \
                WHERE at.deleted=0 AND ct.deleted=0 AND c.deleted=0 AND (CURDATE() BETWEEN ct.begDate AND ct.endDate) GROUP BY at.id, ct.code

        sql_field_string        = code
        sql_field_string        = name
        sql_field_string        = service
        sql_attr_uint        = action_type_id
        sql_attr_uint        = service_id
        sql_attr_float        = price

        sql_attr_multi        = uint eventType_id from field
        sql_attr_multi        = uint speciality_id from field
        sql_attr_multi        = uint contract_id from field
}


index event_service
{
        source                  = event_service
        path                    = /var/lib/sphinxsearch/data/event_service
        docinfo                 = extern
        charset_type            = utf-8
        min_word_len            = 2
        min_prefix_len           = 2

        charset_table = 0..9, A..Z->a..z, _, a..z, U+2E, \
           U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+451, U+451
}


source events
{
        type        = mysql

        sql_host    = %DB_HOST%
        sql_user    = %DB_USER%
        sql_pass    = %DB_PASSWORD%
        sql_db      = %DB_NAME%
        sql_port    = %DB_PORT%

#       sql_query_pre = SET CHARACTER_SET_RESULTS=utf8
        sql_query_pre = SET NAMES utf8
        sql_query_pre = SET CHARACTER SET utf8

        sql_query = \
                SELECT \
                    Event.id, \
                    Event.externalId as external_id, \
                    CONCAT_WS(' ', Client.lastName, Client.firstName, Client.patrName) as client_name, \
                    Client.id as client_code, \
                    Client.birthDate as client_bd \
                FROM \
                    Event \
                    JOIN Person ON Person.id = Event.execPerson_id \
                    JOIN EventType ON Event.eventType_id = EventType.id \
                    JOIN rbRequestType ON EventType.requestType_id = rbRequestType.id \
                    JOIN Client on Client.id = Event.client_id \
                WHERE Event.deleted = 0 \
                GROUP BY Event.id

        sql_field_string      = external_id
        sql_field_string      = client_code
        sql_field_string      = client_name
        sql_field_string      = client_bd
}


index events
{
        source                  = events
        path                    = /var/lib/sphinxsearch/data/events
        docinfo                 = extern
        charset_type            = utf-8
        min_word_len            = 2
        min_prefix_len          = 2

        charset_table = 0..9, A..Z->a..z, _, /, a..z, U+2E, \
           U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+451, U+451
}



source risar_events
{
        type        = mysql

        sql_host    = %DB_HOST%
        sql_user    = %DB_USER%
        sql_pass    = %DB_PASSWORD%
        sql_db      = %DB_NAME%
        sql_port    = %DB_PORT%

#       sql_query_pre = SET CHARACTER_SET_RESULTS=utf8
        sql_query_pre = SET NAMES utf8
        sql_query_pre = SET CHARACTER SET utf8

        sql_query               = \
            SELECT\
                Event.id,\
                Event.externalId as external_id,\
                Event.execPerson_id as exec_person_id,\
                Event.client_id as client_id,\
                UNIX_TIMESTAMP(Event.setDate) DIV 86400 as set_date,\
                UNIX_TIMESTAMP(Event.modifyDatetime) as modify_date,\
                UNIX_TIMESTAMP(Event.execDate) DIV 86400 as exec_date,\
                Person.org_id as org_id,\
                CONCAT_WS(' ', Client.lastName, Client.firstName, Client.patrName) as name,\
                CONCAT_WS(' ', Person.lastName, Person.firstName, Person.patrName) as person_name,\
                apv_risk.value as risk,\
                UNIX_TIMESTAMP(apv_bdate.value) DIV 86400 as bdate,\
                UNIX_TIMESTAMP(apv_psdate.value) DIV 86400  as psdate,\
                GROUP_CONCAT(UNIX_TIMESTAMP(checkup.begDate) DIV 86400 SEPARATOR ',') as checkups\
            FROM\
                Event\
                JOIN Person ON Person.id = Event.execPerson_id\
                JOIN EventType ON (Event.eventType_id = EventType.id)\
                JOIN rbRequestType ON (EventType.requestType_id = rbRequestType.id AND rbRequestType.code = 'pregnancy')\
                JOIN Client on Client.id = Event.client_id\
                LEFT JOIN Action CA ON (\
                    CA.event_id = Event.id AND\
                      CA.actionType_id IN (SELECT id FROM ActionType WHERE ActionType.flatCode = 'cardAttributes') AND\
                      CA.deleted = 0)\
                LEFT JOIN ActionPropertyType apt_risk ON (apt_risk.actionType_id = CA.actionType_id AND apt_risk.code = 'prenatal_risk_572')\
                LEFT JOIN ActionProperty ap_risk ON (ap_risk.action_id = CA.id AND ap_risk.type_id = apt_risk.id)\
                LEFT JOIN ActionProperty_Integer apv_risk ON (ap_risk.id = apv_risk.id)\
                LEFT JOIN ActionPropertyType apt_bdate ON (apt_bdate.actionType_id = CA.actionType_id AND apt_bdate.code = 'predicted_delivery_date')\
                LEFT JOIN ActionProperty ap_bdate ON (ap_bdate.action_id = CA.id AND ap_bdate.type_id = apt_bdate.id)\
                LEFT JOIN ActionProperty_Date apv_bdate ON (ap_bdate.id = apv_bdate.id)\
                LEFT JOIN ActionPropertyType apt_psdate ON (apt_psdate.actionType_id = CA.actionType_id AND apt_psdate.code = 'pregnancy_start_date')\
                LEFT JOIN ActionProperty ap_psdate ON (ap_psdate.action_id = CA.id AND ap_psdate.type_id = apt_psdate.id)\
                LEFT JOIN ActionProperty_Date apv_psdate ON (ap_psdate.id = apv_psdate.id)\
                LEFT JOIN Action checkup ON (\
                     checkup.event_id = Event.id AND\
                      checkup.actionType_id IN (SELECT id FROM ActionType WHERE flatCode IN ('risarFirstInspection', 'risarSecondInspection')) AND\
                      checkup.deleted = 0)\
            WHERE Event.deleted = 0\
            GROUP BY Event.id

        sql_field_string        = name

        sql_attr_string        = person_name
        sql_attr_uint        = modify_date
        sql_attr_uint        = set_date
        sql_attr_uint        = exec_date
        sql_attr_uint        = bdate
        sql_attr_uint        = psdate
        sql_attr_uint        = risk
        sql_attr_uint        = client_id
        sql_attr_string      = external_id
        sql_attr_uint        = exec_person_id
        sql_attr_uint        = org_id
        sql_attr_multi       = uint checkups from field
}


index risar_events
{
        source                  = risar_events
        path                    = /var/lib/sphinxsearch/data/risar_events
        docinfo                 = extern
        charset_type            = utf-8
        min_word_len            = 2
        min_prefix_len          = 2

        charset_table = 0..9, A..Z->a..z, _, a..z, U+2E, \
           U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+451, U+451
}

indexer
{
    mem_limit       = 32M
}


searchd
{
    listen          = 9312
    listen          = 9306:mysql41
    log         = /var/log/sphinxsearch/searchd.log
    query_log       = /var/log/sphinxsearch/query.log
    read_timeout        = 5
    max_children        = 30
    pid_file        = /var/run/sphinxsearch/searchd.pid
    max_matches     = 1000
    seamless_rotate     = 1
    preopen_indexes     = 1
    unlink_old      = 1
    workers         = threads # for RT to work
    binlog_path     = /var/lib/sphinxsearch/data
}
