{% extends 'patients/base.html' %}

{% block title %}> {{ module_name }}{% endblock %}

{% block main %}
    <legend xmlns="http://www.w3.org/1999/html">Пациенты</legend>
    <div ng-controller="ClientSearch" class="ng-cloak">
        <form class="form-horizontal marginal" role="form">
            <div class="input-group">
                <span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
                <input id="search" class="form-control" type="text" ng-model="query"
                       placeholder="Введите код или фамилию или имя пациента">
                <span class="input-group-addon" ng-click="query_clear()" style="cursor: pointer">
                    <span class="glyphicon glyphicon-remove"></span></span>
            </div>
        </form>
        <div class="marginal" ng-if="printError">
            <div class="alert alert-danger alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                [[printError.text]]
            </div>
        </div>
        <table class="table table-condensed table-hover table-clickable">
            <caption>
                <span ng-if="results.length > 0">Результаты поиска</span>
                <span ng-if="results.length === 0 && query">Нет результатов</span>
                <button ng-click="open_client('new');" class="btn btn-primary pull-right"
                        ng-show="!results.length">Зарегистрировать пациента</button>
            </caption>
            <thead ng-if="results.length > 0">
            <tr>
                <th>ФИО</th>
                <th>Дата рождения</th>
                <th>Пол</th>
                <th>Документ</th>
                <th>СНИЛС</th>
                <th>Полис ОМС</th>
                <th>Полис ДМС</th>
                <th></th>
            </tr>
            </thead>
            <tbody ng-if="results.length > 0">
            <tr ng-repeat="result in results" style="cursor: pointer">
                <td ng-click="open_client(result.id)" ng-bind="result.nameText"></td>
                <td ng-click="open_client(result.id)" ng-bind="result.birthDate | asDate"></td>
                <td ng-click="open_client(result.id)" ng-bind="result.sex"></td>
                <td ng-click="open_client(result.id)" ng-bind="result.documentText"></td>
                <td ng-click="open_client(result.id)" ng-bind="result.SNILS"></td>
                <td ng-click="open_client(result.id)" ng-bind="result.compulsoryPolicyText"></td>
                <td ng-click="open_client(result.id)" ng-bind="result.voluntaryPolicyText"></td>
                <td>
                    <div class="dropdown">
                        <button class="btn dropdown-toggle" type="button" id="print_dropdownMenu"
                                ng-disabled="!ps.templates" data-toggle="dropdown">
                            <span class="glyphicon glyphicon-print"></span>
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="print_dropdownMenu">
                            <li role="presentation" ng-repeat="template in ps.templates">
                                <a role="menuitem" tabindex="-1" href="" class="print_template"
                                   ng-click="ps.print_template(result.id, template.id)" ng-bind="template.name">
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
{#        <pre>[[schedule|json]]</pre>#}
    </div>
{% endblock %}

{% block modules_js %}
    {{ super() }}
    <script type="text/javascript">
        WebMis20.controller('ClientSearch',
                ['$scope', '$http', '$timeout', '$window', 'PrintingService',
                function ($scope, $http, $timeout, $window, PrintingService) {
            $scope.ps = new PrintingService('registry', function (template_id, client_id) {
                return {
                    client_id: client_id,
                    additional_context: {
                        'currentOrgStructure': "",
                        'currentOrganisation': 3479,
                        'currentPerson': "1"
                    }
                }
            });
            $scope.ps.set_context('token');
            $scope.aux = aux;
            $scope.params = aux.getQueryParams(document.location.search);
            $scope.query = "";
            $scope.results = [];
            var _timeoutObjectForQuery;

            $scope.$watch('query', function (val) {
                if (_timeoutObjectForQuery) $timeout.cancel(_timeoutObjectForQuery);
                _timeoutObjectForQuery = $timeout(function () {
                    $scope.results = null;
                    $scope.perform_search(val);
                }, 500)
            });

            $scope.perform_search = function (val) {
                if (!val) {
                    $scope.results = [];
                } else {
                    $http.get(
                        '{{ url_for('.api_search_clients') }}', {
                            params: {
                                q: val
                            }
                        }
                    ).success(function (data) {
                        $scope.results = data.result;
                    })
                }
            };

            $scope.open_client = function (client_id) {
                window.open('{{ url_for('patients.patient') }}?client_id=' + client_id, '_self');
            };

            $scope.$on('printing_error', function (event, error) {
                $scope.printError = error;
            });

            $scope.query_clear = function () {
                $scope.query = '';
            }
        }]);
    </script>
{% endblock %}
