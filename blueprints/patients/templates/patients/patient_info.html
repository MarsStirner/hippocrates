{% extends 'patients/base.html' %}

{% block title %}> {{ module_name }}{% endblock %}

{% block main %}
    <div ng-controller="ClientCtrl" class="ng-cloak">
        <script type="text/ng-template" id="modal-deleteRecord.html">{% include "patients/_modal_delete_record.html" %}</script>
        <legend xmlns="http://www.w3.org/1999/html">Пациент [[ clientDataItems.nameText ]]</legend>
        <div class="marginal">
            <button class="btn btn-default" onclick="history.back()">Назад к результатам поиска</button>
            <a class="btn btn-success" href="{{ url_for('schedule.appointment') }}?client_id={{ request.args['client_id'] }}">
                Записать на приём</a>
        </div>
        <tabset>
            <tab>
                <tab-heading>
                    Информация о пациенте
                    <a ng-click="start_editing();" class="glyphicon glyphicon-pencil" href="" title="Редактировать"></a>
                </tab-heading>
                <tabset justified="false">
                    <tab heading="Основная информация">{% include "patients/main_info.html" %}</tab>
                    <tab heading="Соц. статус">{% include "patients/soc_status.html" %}</tab>
                    <tab heading="Особенности">{% include "patients/characteristics.html" %}</tab>
                    <tab heading="Идентификаторы">{% include "patients/identifiers.html" %}</tab>
                    <tab heading="Связи и контакты">{% include "patients/contacts.html" %}</tab>
                    <tab heading="История документов">{% include "patients/documents.html" %}</tab>
                    <tab heading="Debug"><span ng-bind="client.client_info.lastName"></span></tab>
                </tabset>
            </tab>
            <tab heading="Предварительные записи">{% include "patients/appointments.html" %}</tab>
            <tab heading="Обращения">{% include "patients/event_list.html" %}</tab>
        </tabset>
        <br /> {# FIXME, daaamn #}
        <div class="pull-right" ng-show="editing">
            <button ng-click="cancel_editing();" class="btn btn-lg btn-danger">Отменить</button>
            <button ng-click="save_client();" class="btn btn-lg btn-success">Сохранить</button>
        </div>
    </div>
{% endblock %}

{% block modules_js %}
    {{ super() }}
    <script type="text/javascript">
        DeleteRecordModalCtrl = function ($scope, $modalInstance) {
            $scope.accept = function () {
                $modalInstance.close();
            };
            $scope.cancel = function () {
                $modalInstance.dismiss('cancel');
            };
        };
        WebMis20.factory('Client',
            function($resource) {
                return $resource('{{ url_for('patients.api_patient_get') }}' + '?client_id=:client_id', {}, {
                    query: {method: 'GET', params: {client_id: 1}}
                });
        });
        WebMis20.controller('ClientCtrl', ['$scope', '$http', '$modal', 'ClientNTK',
                            function ($scope, $http, $modal, ClientNTK) {
            $scope.records = [];
            $scope.aux = aux;
            $scope.params = aux.getQueryParams(document.location.search);
            $scope.client_id = $scope.params.client_id;

            $scope.clientInfoCode2Name = {
                'id': 'Код пациента',
                'birthDate': 'Дата рождения',
                'regAddress': 'Адрес регистрации',
                'liveAddress': 'Адрес проживания',
                'SNILS': 'СНИЛС',
                'nameText': 'ФИО',
                'sex': 'Пол',
                'documentText': 'Документ',
                'contact': 'Контакты',
                'voluntaryPolicyText': 'Полис ДМС',
                'compulsoryPolicyText': 'Полис ОМС',
                'notes': 'Примечания'
            };
            $scope.clientMainInfoCodeOrder = ['id', 'nameText', 'birthDate', 'sex', 'regAddress', 'liveAddress',
                'documentText', 'compulsoryPolicyText', 'voluntaryPolicyText', 'SNILS', 'contact', 'notes'];

            $scope.start_editing = function() {
                $scope.editing = true;
            };

            $scope.cancel_editing = function() {
                $scope.editing = false;
                $scope.client = new ClientNTK($scope.client_id); // FIXME defer/promise or reload
            };

            $scope.save_client = function() {
                var promise = $scope.client.save();
                promise.then(function(result) {
                    $scope.editing = false;
                }, function(reason) {
                    alert(reason);
                }
                );
            }

{#            $scope.delete_document = function(document) {#}
{#                var modalInstance = $modal.open({#}
{#                                    templateUrl: 'modal-deleteDocument.html',#}
{#                                    controller: DeleteDocumentModalCtrl#}
{#                    });#}
{#                modalInstance.result.then(function () {#}
{#                    $http.get('{{ url_for('.api_delete_document') }}',#}
{#                              {params: {document: document}#}
{#                              }#}
{#                    );#}
{#                })#}
{#            };#}

            $scope.delete_record = function(entity, record) {
                var modalInstance = $modal.open({
                    templateUrl: 'modal-deleteRecord.html',
                    controller: DeleteRecordModalCtrl
                });

                modalInstance.result.then(function () {
                    $scope.client.delete_record(entity, record);
                });
            };

            $scope.open = function($event) {
                $event.preventDefault();
                $event.stopPropagation();
                return true;
            };

            $scope.open_event = function(event) {
                window.open('{{ url_for('schedule.html_event_info') }}?event_id=' + event.id, '_self')
            };

            $scope.$watchCollection('[client.client_info.firstName, client.client_info.lastName, client.client_info.patrName]',
                function() {
                    $scope.client.update_fullName();
                }
            )
            if ($scope.client_id == 'new') {
                $scope.start_editing();
                // TODO: btnCancel href back
            }

            $scope.client = new ClientNTK($scope.client_id);

        }]);
    </script>
{% endblock %}
