<script>
WebMis20.controller('EventDiagnosesCtrl', ['$scope', 'RefBookService', '$http',
    function($scope, RefBookService, $http) {
        $scope.rbDiagnosisType = RefBookService.get('rbDiagnosisType');
        $scope.rbDiseaseCharacter = RefBookService.get('rbDiseaseCharacter');
        $scope.rbDiseasePhases = RefBookService.get('rbDiseasePhases');
        $scope.rbDiseaseStage = RefBookService.get('rbDiseaseStage');
        $scope.rbHealthGroup = RefBookService.get('rbHealthGroup');
        $scope.rbDispanser = RefBookService.get('rbDispanser');
        $scope.rbTraumaType = RefBookService.get('rbTraumaType');
        $scope.Person = RefBookService.get('Person');

        $scope.$on('event_loaded', function() {
            $scope.diagnoses = $scope.event.diagnoses || [];
        });

        $scope.diag_edit = [];
        $scope.diag_edit_start = function (index) {
            if (!$scope.diag_edit[index]) {
                $scope.diag_edit[index] = angular.extend({}, $scope.diagnoses[index])
            }
        };
        $scope.diag_edit_save = function (index) {
            if ($scope.diag_edit[index]) {
                $scope.diagnoses[index] = $scope.diag_edit[index];
                $scope.diagnoses[index]._dirty = true;
                $scope.diagnoses[index].client_id = $scope.event.info.client_id;
                $scope.diagnoses[index].event_id = $scope.event.info.id;
                $http.post(url_for_event_api_diagnosis_save, $scope.diagnoses[index]).then(function () {
                    $scope.diag_edit[index] = undefined;
                    delete $scope.diagnoses[index]._first;
                });
            }
        };
        $scope.diag_edit_stop = function (index) {
            if ($scope.diag_edit[index]) {
                if ($scope.diag_edit[index]._first) {
                    $scope.diagnoses.splice(index, 1);
                }
                $scope.diag_edit[index] = undefined;
            }
        };
        $scope.diag_edit_new = function () {
            $scope.diagnoses.splice(0, 0, {
                person: $scope.Person.get({{ current_user.get_id() }}),
                _new: true,
                _first: true
            });
            $scope.diag_edit_start(0);
        };
        $scope.diag_edit_save_disabled = function (index) {
            var q = $scope.diag_edit[index];
            return !q.diagnosis_type;
        };

}]);
</script>