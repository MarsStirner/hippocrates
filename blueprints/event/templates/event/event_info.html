{% extends "event/base.html" %}

{% import "schedule/client_event/action_list.html" as action_list %}

{% block modules_css %}
    {{ super() }}
    <style>
        .list-no-border .list-group-item {
            border: 0;
        }
        .list-no-border li div {
            display: inline-block;
        }
    </style>
{% endblock %}

{% block main %}
    <div ng-controller="EventInfoCtrl" class="ng-cloak">
        <legend xmlns="http://www.w3.org/1999/html">
            <h2 class="no-top-margin">[[event.is_new() ? 'Создание обращения' : 'Обращение № ' + event.info.external_id]], пациент
                <a href="{{ url_for('patients.patient') }}?client_id=[[event.info.client_id]]">[[ event.info.client.fullName ]]</a>
            </h2>
        </legend>

        <div class="marginal">
            <alert ng-repeat="alert in alerts" type="alert.type" close="alerts.splice(index, 1)">[[ alert.text ]] [ [[alert.code]] ]</alert>
        </div>

        {# В зависимости от ролей и прав разный лейаут #}
        {% if form_role == 'doctor' %}
            <tabset>
                <tab><tab-heading>Основная Информация</tab-heading>
                    {% include "event/_main_info.html" %}
                    {% include "event/diagnoses.html" %}
                </tab>
                <tab><tab-heading>Медицинские документы</tab-heading>
                    {{ action_list.action_list('event.info.med_doc_actions', 0) }}
                </tab>
                <tab><tab-heading>Диагностика и лаб.исследования</tab-heading>
                    {{ action_list.action_list('event.info.diag_actions', 1) }}
                </tab>
                <tab><tab-heading>Лечение</tab-heading>
                    {{ action_list.action_list('event.info.cure_actions', 2) }}
                </tab>
            </tabset>
        {% elif form_role == 'receptionist' %}
            <ng-form name="event_form">
                {% include "event/_main_info.html" %}
                {% include "event/_services.html" %}
                {% include "event/_payment.html" %}
            </ng-form>
        {% endif %}

        <div class="row">
            <div class="col-md-12">
                <div class="pull-right">
                    <button type="button" ng-click="cancel_editing();" class="btn btn-lg btn-danger">Назад</button>
                    <button type="button" ng-click="save_event();" class="btn btn-lg btn-success"
                            ng-bind="event.is_new() ? 'Создать' : 'Сохранить'">Создать</button>
                </div>
            </div>
        </div>
        <div>
            <p>debug:</p>
            <p>[[event | json]]</p>
        </div>
    </div>
{% endblock %}

{% block modules_js %}
{{ super() }}
<script>
    WebMis20.controller('EventInfoCtrl', ['$scope', 'WMEvent', '$http', 'RefBookService', '$window', 'PrintingService', 'Settings',
        function ($scope, WMEvent, $http, RefBookService, $window, PrintingService, Settings) {

        $scope.aux = aux;
        $scope.Settings = new Settings();

        $scope.event_id = aux.getQueryParams(location.search).event_id;
        $scope.client_id = aux.getQueryParams(location.search).client_id;
        $scope.event = new WMEvent($scope.event_id, $scope.client_id);
        $scope.editing = {
            submit_attempt: false
        };

        $scope.initialize = function() {
            $scope.event.reload().
                then(function() {
                    $scope.$broadcast('event_loaded');
                    if ($scope.event.is_new()) {

                    } else {
                        $scope.ps.set_context($scope.event.info.event_type.print_context)
                    }
                });
            {% if form_role == 'doctor' %}
            aux.range(3).map(function (at_class) {
                $http.get('{{ url_for('schedule.api_atl_get') }}', {
                    params: {
                        at_class: at_class
                    }
                }).success(function (data) {
                    $scope.action_type_tree[at_class] = data.result;
                })
            });
            {% endif %}
        };

        $scope.save_event = function() {
            $scope.editing.submit_attempt = true;
            if ($scope.event_form.$valid) {
                $scope.event.info.services = $scope.selected_services;

                $scope.event.save().
                    then(function(event_id) {
                        if ($scope.event.is_new()) {
                            $window.open('{{ url_for('.html_event_info') }}' + '?event_id=' + event_id, '_self');
                        } else {
                            $scope.event.reload();
                        }
                    }, function(reason) {
                        alert(reason);
                    });
            }
        };


        $scope.ps = new PrintingService("event", function (template_id) {
            return {
                event_id: $scope.event_id
            }
        });

        $scope.print_template = function (template_id) {
            $http.post(
                '{{ print_subsystem_url }}', {
                    id: template_id,
                    context_type: "event",
                    event_id: $scope.event_id,
                    additional_context: {
                        currentOrgStructure: "",
                        currentOrganisation: 3479,
                        currentPerson:"1"
                    }
                }).success(function (data) {
                    $scope.w = $window.open();
                    $scope.w.document.open();
                    $scope.w.document.write(data);
                    $scope.w.document.close();
                    $scope.w.print();
               })
        };

        $scope.$on('printing_error', function (event, error) {
            $scope.alerts.push(error);
        });

{#        $scope.event_edit_list = [];#}
{#        $scope.start_edit = function(element) {#}
{#            $scope.event_edit_list.push(element);#}
{#        };#}
{##}
{#        $scope.stop_edit = function(element) {#}
{#            $scope.event_edit_list.splice($scope.event_edit_list.indexOf(element), 1);#}
{#        };#}


{#        $scope.edit = true;#}

        $scope.action_type_tree = [];
        $scope.action_type_popped = null;
        $scope.at_pop_toggle = function (at_class) {
            if ($scope.action_type_popped === at_class) {
                $scope.action_type_popped = null;
            } else {
                $scope.action_type_popped = at_class;
            }
        };

        $scope.hidden_nodes = [];
        $scope.toggle_vis = function (node_id) {
            if (aux.inArray($scope.hidden_nodes, node_id)) {
                $scope.hidden_nodes.splice($scope.hidden_nodes.indexOf(node_id), 1);
            } else {
                $scope.hidden_nodes.push(node_id);
            }
        };
        $scope.subtree_shown = function (node_id) {
            return !aux.inArray($scope.hidden_nodes, node_id);
        };

        $scope.open_action = function (action_id) {
            window.open('{{ url_for('schedule.html_action') }}?action_id=' + action_id);
        };

        $scope.initialize();
    }]);
</script>
{% include "event/_main_info_js.html" %}
{% if form_role == 'receptionist' %}
    {% include "event/_services_js.html" %}
    {% include "event/_payment_js.html" %}
{% endif %}
{% endblock %}