{% extends "event/base.html" %}

{% import "schedule/client_event/action_list.html" as action_list %}

{% block main %}
    <div ng-controller="EventInfoCtrl" class="ng-cloak">
        {% include "_breadcrumbs.html" %}
        <legend xmlns="http://www.w3.org/1999/html" wm-page-header>
            <div class="pull-right text-right col-md-1"><button type="button" ng-click="save_event();" ng-hide="event.is_new();" class="btn btn-success" title="Сохранить"><span class="glyphicon glyphicon-ok"></span></button></div>
            <h2>[[event.is_new() ? 'Создание обращения' : 'Обращение № ' + event.info.external_id]], пациент
                <a href="{{ url_for('patients.patient') }}?client_id=[[event.info.client_id]]">[[ event.info.client.info.full_name ]]</a>
            </h2>
        </legend>

        <div ui-alert-list="alerts"></div>
        <div class="well well-sm">
            <div class="row">
                <div class="col-md-9">
                    <dl class="dl-horizontal novmargin">
                        <dt>Контактный телефон:</dt><dd>[[event.info.client.contact]]&nbsp;</dd>
                        <dt>Адрес регистрации:</dt><dd>[[event.info.client.reg_address ? event.info.client.reg_address.text_summary : '']]&nbsp;</dd>
                        <dt>Адрес проживания:</dt><dd>[[event.info.client.live_address ? event.info.client.live_address.text_summary : '']]&nbsp;</dd>
                        <dt>Документ:</dt><dd>[[event.info.client.id_document ? event.info.client.id_document.doc_text : '']]&nbsp;</dd>
                        <dt>Медицинский полис:</dt><dd ng-repeat="policy_text in policies">[[policy_text]]&nbsp;</dd>
                    </dl>
                </div>
                <div class="col-md-3">
                    <dl class="dl-horizontal novmargin pull-right">
                        <dt>Код пациента:</dt><dd>[[event.info.client.info.id]]&nbsp;</dd>
                        <dt>Дата рождения:</dt><dd>[[event.info.client.info.birth_date|asDate]]&nbsp;</dd>
                        <dt>Пол:</dt><dd>[[event.info.client.info.sex.name]]&nbsp;</dd>
                    </dl>
                </div>
            </div>
        </div>
        <ng-form name="event_form" form-safe-close>
        {# В зависимости от ролей и прав разный лейаут #}
        {% if form_role == 'admin' %}
            <tabset>
                <tab><tab-heading>Основная Информация</tab-heading>
                    {% include "event/_main_info.html" %}
                    {% if not event_new %}
                        {% include "event/_diagnoses.html" %}
                    {% endif %}
                    {% include "event/_services.html" %}
                    {% include "event/_payment.html" %}
                </tab>
                {% if not event_new %}
                <tab><tab-heading>Медицинские документы</tab-heading>
                    {{ action_list.action_list('event.info.med_doc_actions', 0) }}
                </tab>
                <tab><tab-heading>Диагностика и лаб.исследования</tab-heading>
                    {{ action_list.action_list('event.info.diag_actions', 1) }}
                </tab>
                <tab><tab-heading>Лечение</tab-heading>
                    {{ action_list.action_list('event.info.cure_actions', 2) }}
                </tab>
                {% endif %}
            </tabset>

        {% elif form_role == 'doctor' %}
            <tabset>
                <tab><tab-heading>Основная Информация</tab-heading>
                    {% include "event/_main_info.html" %}
                    {% include "event/_diagnoses.html" %}
                </tab>
                <tab><tab-heading>Медицинские документы</tab-heading>
                    {{ action_list.action_list('event.info.med_doc_actions', 0) }}
                </tab>
                <tab><tab-heading>Диагностика и лаб.исследования</tab-heading>
                    {{ action_list.action_list('event.info.diag_actions', 1) }}
                </tab>
                <tab><tab-heading>Лечение</tab-heading>
                    {{ action_list.action_list('event.info.cure_actions', 2) }}
                </tab>
            </tabset>
        {% elif form_role == 'receptionist' %}
                {% include "event/_main_info.html" %}
                {% include "event/_services.html" %}
                {% include "event/_payment.html" %}
        {% endif %}
        </ng-form>
        <div class="row">
            <div class="col-md-6 text-left">
                <ui-print-button ps="ps" resolve="ps_resolve()" ng-if="!event.is_new()"></ui-print-button>
{#                <div class="dropup" ng-if="!event.is_new()">#}
{#                    <button class="btn btn-lg btn-default dropdown-toggle" type="button" id="print_dropdownMenu"#}
{#                            data-toggle="dropdown" ng-disabled="!ps.templates">#}
{#                        <span class="glyphicon glyphicon-print"></span> Печать <span class="caret"></span>#}
{#                    </button>#}
{#                    <ul class="dropdown-menu dropdown-menu" role="menu" aria-labelledby="print_dropdownMenu">#}
{#                        <li role="presentation" ng-repeat="template in ps.templates">#}
{#                            <a role="menuitem" tabindex="-1" href="" class="print_template"#}
{#                               ng-click="ps.print_template(template.id)" ng-bind="template.name"></a>#}
{#                        </li>#}
{#                    </ul>#}
{#                </div>#}
            </div>
            <div class="col-md-6 text-right">
                <button type="button" ng-click="save_event();" class="btn btn-lg btn-success"
                        ng-bind="event.is_new() ? 'Создать' : 'Сохранить'">Создать</button>
                {% if form_role == 'doctor' %}
                <button type="button" ng-click="close_event();" class="btn btn-lg btn-info"
                        tooltip="[[event.is_closed ? 'Обращение уже закрыто': '']]">Закрыть обращение</button>
                {% endif %}
                <button type="button" ng-click="cancel_editing();" class="btn btn-lg btn-danger">Закрыть</button>
            </div>
        </div>
{#        <div>#}
{#            <p>debug:</p>#}
{#            <pre>[[event | json]]</pre>#}
{#        </div>#}
    </div>
    <script type="text/ng-template" id="modal-print-dialog.html">{% include "_modal-print-dialog.html" %}</script>
    <script type="text/ng-template" id="modal-unclosed-actions.html">{% include "event/_modal_unclosed_actions.html" %}</script>
{% endblock %}

{% block modules_js %}
{{ super() }}
<script>
    WebMis20.controller('EventInfoCtrl', ['$scope', 'WMEvent', '$http', 'RefBookService', '$window', 'PrintingService', 'Settings', '$filter', '$modal',
        function ($scope, WMEvent, $http, RefBookService, $window, PrintingService, Settings, $filter, $modal) {

        $scope.aux = aux;
        $scope.Organisation = RefBookService.get('Organisation');
        $scope.Settings = new Settings();
        $scope.alerts = [];

        var params = aux.getQueryParams(location.search);
        $scope.event_id = params.event_id;
        $scope.client_id = params.client_id;
        $scope.ticket_id = params.ticket_id;
        $scope.event = new WMEvent($scope.event_id, $scope.client_id, $scope.ticket_id);
        $scope.editing = {
            submit_attempt: false
        };
        $scope.policies = [];

        $scope.initialize = function() {
            $scope.event.reload().
                then(function() {
                    $scope.$broadcast('event_loaded');
                    if ($scope.event.is_new()) {

                    } else {
                        $scope.ps.set_context($scope.event.info.event_type.print_context)
                    }

                    if ($scope.event.info.client.compulsory_policy && $scope.event.info.client.compulsory_policy.policy_text) {
                        $scope.policies.push($scope.event.info.client.compulsory_policy.policy_text + ' ('+ $filter('asDate')($scope.event.info.client.compulsory_policy.beg_date) + '-' + $filter('asDate')($scope.event.info.client.compulsory_policy.end_date) +')');
                    }
                    if ($scope.event.info.client.voluntary_policies.length>0) {
                        angular.forEach($scope.event.info.client.voluntary_policies, function (value, key) {
                            $scope.policies.push(value.policy_text + ' ('+ $filter('asDate')(value.beg_date) + '-' + $filter('asDate')(value.end_date) + ')');
                        });
                    }
                });
            {% if form_role == 'doctor' or form_role == 'admin' %}
            aux.range(3).map(function (at_class) {
                $http.get('{{ url_for('schedule.api_atl_get') }}', {
                    params: {
                        at_class: at_class
                    }
                }).success(function (data) {
                    $scope.action_type_tree[at_class] = data.result;
                })
            });
            {% endif %}
        };

        $scope.save_event = function(close_event) {
            if (typeof (close_event) === 'undefined') {
                close_event = false;}
            $scope.editing.submit_attempt = true;
            if ($scope.event_form.$valid) {
                $scope.event.save(close_event).
                    then(function(event_id) {
                        $scope.event_form.$setPristine();
                        if ($scope.event.is_new()) {
                            $window.open('{{ url_for('.html_event_info') }}' + '?event_id=' + event_id, '_self');
                        } else {
                            $scope.event.reload().then(function() {
                                $scope.$broadcast('event_loaded');
                            });
                        }
                        if (close_event) {alert("Обращение закрыто");};
                    }, function(reason) {
                        alert(reason);
                    });

            }
        };

        $scope.event_mandatoryResult = function() {
            return $scope.Settings.get_string('Event.mandatoryResult') == '1';
        };

        $scope.event_check_results = function() {
            if (!$scope.event.info.result){
                alert("Необходимо задать результат");
                return false
            };
            if (!$scope.event.info.ache_result && $scope.event_mandatoryResult()){
                alert("Необходимо задать исход заболевания/госпитализации");
                return false
            };
            return true;
        };

        $scope.open_unclosed_actions_modal = function(unclosed_actions) {
            var modalInstance = $modal.open({
                templateUrl: 'modal-unclosed-actions.html',
                controller: UnclosedActionsModalCtrl,
                resolve: {
                    unclosed_actions: function(){
                        return unclosed_actions;
                    }
                },
                scope: $scope
            });
            modalInstance.result.then(function () {
                $scope.save_event(true);
            });
        };

        $scope.close_event = function(){
            if (!$scope.event.is_closed){
                var unclosed_actions = $scope.event.get_unclosed_actions();
                if (!$scope.event_check_results()){
                    return false;
                } else if (unclosed_actions.length){
                    $scope.open_unclosed_actions_modal(unclosed_actions);
                } else {
                    $scope.save_event(true);
                }
            }
        };

        $scope.cancel_editing = function(){
          if (window.opener){
              window.opener.focus();
              window.close();
          }
        };

        $scope.ps = new PrintingService("event");
        $scope.ps_resolve = function () {
            return {
                event_id: $scope.event_id
            }
        }

        $scope.filter_results = function(event_purpose) {
            return function(elem) {
                return elem.eventPurpose_id == event_purpose;
            };
        };

        $scope.print_template = function (template_id) {
            $http.post(
                '{{ print_subsystem_url }}', {
                    id: template_id,
                    context_type: "event",
                    event_id: $scope.event_id,
                    additional_context: {
                        currentOrgStructure: "",
                        currentOrganisation: 3479,
                        currentPerson:"1"
                    }
                }).success(function (data) {
                    var w = $window.open();
                    w.document.open();
                    w.document.write(data);
                    w.document.close();
                    w.print();
               })
        };

        $scope.$on('printing_error', function (event, error) {
            $scope.alerts.push(error);
        });

        {# todo: action data not here #}
        $scope.action_type_tree = [];
        $scope.action_type_popped = null;
        $scope.at_pop_toggle = function (at_class) {
            if ($scope.action_type_popped === at_class) {
                $scope.action_type_popped = null;
            } else {
                $scope.action_type_popped = at_class;
            }
        };

        $scope.hidden_nodes = [];
        $scope.toggle_vis = function (node_id) {
            if (aux.inArray($scope.hidden_nodes, node_id)) {
                $scope.hidden_nodes.splice($scope.hidden_nodes.indexOf(node_id), 1);
            } else {
                $scope.hidden_nodes.push(node_id);
            }
        };
        $scope.subtree_shown = function (node_id) {
            return !aux.inArray($scope.hidden_nodes, node_id);
        };

        $scope.open_action = function (action_id) {
            window.open('{{ url_for('schedule.html_action') }}?action_id=' + action_id);
        };
        {# action data end #}

        $scope.$watch('event.info.contract', function(new_val, old_val) {
            if (new_val != old_val) {
              $scope.$broadcast('form_state_change', {
                  finance: $scope.event.info.event_type.finance,
                  contract: new_val
              });
            }
        }, true);

        $scope.initialize();
    }]);

UnclosedActionsModalCtrl = function ($scope, $modalInstance, unclosed_actions) {
    $scope.unclosed_actions = unclosed_actions;
    $scope.accept = function() {
        $modalInstance.close();
    };
    $scope.cancel = function() {
        $modalInstance.dismiss('cancel');
    };
};
</script>
{% include "event/_main_info_js.html" %}
{% if form_role == 'doctor' or form_role == 'admin' %}
    {% include "event/_diagnoses_js.html" %}
{% endif %}
{% if form_role == 'receptionist' or form_role == 'admin' %}
    {% include "event/_services_js.html" %}
    {% include "event/_payment_js.html" %}
{% endif %}
{% endblock %}