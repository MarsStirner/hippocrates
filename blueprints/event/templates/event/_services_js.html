<script>
WebMis20.controller('EventServicesCtrl', ['$scope', '$http', 'WMEventService',
    function($scope, $http, WMEventService) {
        $scope.query = "";
        $scope.found_services = null;
        $scope.search_processed = false;
        $scope.full_sum = 0;

        $scope.finance_is_oms = function(){return $scope._finance && $scope._finance.code == '2'};
        $scope.finance_is_dms = function(){return $scope._finance && $scope._finance.code == '3'};

        $scope.perform_search = function(val) {
            $scope.search_processed = false;
            if (!val) {
                $scope.found_services = null;
            } else {
                $http.get(
                    '{{ url_for('.api_search_services') }}', {
                        params: {
                            q: val,
                            client_id: $scope.event.info.client_id,
                            event_type_id: $scope.event.info.event_type.id,
                            contract_id: $scope.event.info.contract ? $scope.event.info.contract.id : null,
                            person_id: $scope.event.info.exec_person ? $scope.event.info.exec_person.id : null
                        }
                    }
                ).success(function (data) {
                    $scope.found_services = data.result;
                    $scope.search_processed = true;
                });
            }
        };

        $scope.query_clear = function() {
            $scope.found_services = null;
            $scope.query = '';
        };

        $scope.add_service = function(service) {
            if (!aux.inArray($scope.event.services, service)) {
                var service_data = angular.extend(service, {
                    amount: 1,
                    is_new: true,
                    sum: service.price,
                    actions: [],
                    coord_actions: [],
                    coord_count: 0
                });
                $scope.event.services.push(new WMEventService(service_data, $scope.event.payment.payments));
            }
        };

        $scope.remove_service = function(index) {
            var service = $scope.event.services[index];
            if (service.actions.length) {
                $http.post(
                    '{{ url_for('.api_service_delete_service') }}', {
                        event_id: $scope.event.info.id,
                        action_id_list: service.actions
                    }
                ).success(function() {
                    $scope.event.services.splice(index, 1);
                }).error(function() {
                    alert('error');
                });
            } else {
                $scope.event.services.splice(index, 1);
            }
        };

        $scope.$watch('event.services', function(new_val, old_val) {
            if (new_val) {
                $scope.full_sum = new_val.map(function(service) {
                    return service.price * service.amount;
                }).reduce(function(prev_val, cur_val) {
                    return prev_val + cur_val;
                }, 0);

                var payment = $scope.event.payment;
                $scope.paid_sum = payment && payment.payments.map(function(payment) {
                    return payment.sum + payment.sum_discount;
                }).reduce(function(prev_val, cur_val) {
                    return prev_val + cur_val;
                }, 0) || 0;
            }
        }, true);

        $scope.$on('form_state_change', function(event, arg) {
            $scope._finance = arg['finance'];
            $scope._contract = arg['contract'];
            $scope.query_clear();
        });

        $scope.pay = function(service) {
            var act_to_pay = null;
            var paid_actions = $scope.event.payment.payments.map(function(p) {
                return p.action_id;
            });
            service.actions.forEach(function(a_id) {
                if (act_to_pay === null && (paid_actions.indexOf(a_id) == -1)) {
                    act_to_pay = a_id;
                }
            });
            if (act_to_pay) {
                $http.post(
                    '{{ url_for('.api_service_make_payment') }}', {
                        event_id: $scope.event.info.id,
                        service_id: service.service_id,
                        action_id: act_to_pay,
                        sum: service.price
                    }
                ).success(function() {
{#                    alert('ok');#}
                }).error(function() {
                    alert('error');
                });
            }
            $scope.event.reload();
        };

        $scope.apply_coord_service = function(service) {
            if ($scope.event.info.id){
                service.coord_person_id = current_user_id;
                $http.post(
                    '{{ url_for('.api_service_add_coord') }}', {
                        event_id: $scope.event.info.id,
                        finance_id: $scope.event.info.contract.finance.id,
                        service: service
                    }
                ).success(function(result) {
                    service.actions = result['result']['data'];
                    service.coord_actions = result['result']['data'];
                    service.coord_count = service.coord_actions.length;
{#                    alert('ok');#}
                }).error(function() {
                    service.coord_person_id = undefined;
                    alert('error');
                });
            } else {
                service.coord_person_id = current_user_id;
                service.coord_count = service.amount;
            }
{#            $scope.event.reload();#}
        };

        $scope.remove_coord_service = function(service) {
            if ($scope.event.info.id){
                $http.post(
                    '{{ url_for('.api_service_remove_coord') }}', {
                        action_id: service.coord_actions,
                        coord_person_id: null
                    }
                ).success(function() {
                    service.coord_actions = [];
                    service.coord_person_id = null;
                    service.coord_count = service.coord_actions.length;
{#                    alert('ok');#}
                }).error(function() {
                    alert('error');
                });
            } else {
                service.coord_actions = [];
                service.coord_person_id = null;
                service.coord_count = service.coord_actions.length;
            }
{#            $scope.event.reload();#}
        };

}]);
</script>