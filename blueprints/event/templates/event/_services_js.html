<script>
WebMis20.controller('EventServicesCtrl', ['$scope', '$http',
    function($scope, $http) {
        $scope.query = "";
        var _timeout;
        $scope.selected_services = [];
        $scope.full_sum = 0;

        $scope.perform_search = function(val) {
            if (!val) {
                $scope.found_services = [];
            } else {
                $http.get(
                    '{{ url_for('.api_search_services') }}', {
                        params: {
                            q: val,
                            client_id: $scope.event.info.client_id,
                            event_type_id: $scope.event.info.event_type.id,
                            contract_id: $scope.event.info.contract ? $scope.event.info.contract.id : null,
                            person_id: $scope.event.info.exec_person ? $scope.event.info.exec_person.id : null
                        }
                    }
                ).success(function (data) {
                    $scope.found_services = data.result;
                })
            }
        };

        $scope.query_clear = function() {
            $scope.found_services = null;
            $scope.query = '';
        };

        $scope.add_service = function(service) {
            if (!aux.inArray($scope.selected_services, service)){
                service.amount = 1;
                service.sum = service.price * service.amount;
                $scope.selected_services.push(service);
            }
        };

        $scope.remove_service = function(index) {
            $scope.selected_services.splice(index);
        };

        $scope.$watch('selected_services', function(new_services, old_services) {
            $scope.full_sum = 0;
            for (var i=0; i<new_services.length; i++){
                $scope.full_sum += new_services[i].price * new_services[i].amount;
            }
        }, true);


}]);
</script>