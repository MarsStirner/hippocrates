<div ng-controller="EventDiagnosesCtrl">
<div class="row" ng-hide="diag_edit[0]._first">
    <div class="col-md-12 marginal"><button class="btn btn-primary" ng-click="diag_edit_new()">Новый диагноз</button></div>
</div>
<div class="row" ng-repeat="diagnose in diagnoses">
    <div class="col-md-12">
        <div class="panel panel-info">
            <div class="panel-heading">
                <a ng-if="!diag_edit[$index]" ng-click="diag_edit_start($index)"
                   class="btn btn-default glyphicon glyphicon-edit"></a>
                <a ng-if="diag_edit[$index]" ng-click="diag_edit_save($index)"
                   class="btn btn-success glyphicon glyphicon-ok" ng-disabled="diag_edit_save_disabled($index)"></a>
                <a ng-if="diag_edit[$index]" ng-click="diag_edit_stop($index)"
                   class="btn btn-danger glyphicon glyphicon-remove"></a>
                Диагноз ([[ diagnose.diagnosis_type.name ]])
            </div>
            <div class="panel-body">
                <form class="form form-inline">
                    <fieldset class="row">
                        <div class="form-group col-md-4">
                            <label>Тип диагноза</label>
                            {{ macros.ui_select_tmp('diagnose', 'diagnosis_type', 'rbDiagnosisType', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-4">
                            <label>Врач</label>
                            {{ macros.ui_select_tmp('diagnose', 'person', 'Person', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-2">
                            <label>МКБ</label>
                            {{ macros.ui_select_tmp_noa('diagnose', 'mkb', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-2">
                            <label>доп. МКБ</label>
                            {{ macros.ui_select_tmp_noa('diagnose', 'mkb_ex', 'diag_edit[$index]') }}
                        </div>
                    </fieldset>
                    <fieldset class="row">
                        <div class="form-group col-md-4">
                            <label>Характер</label>
                            {{ macros.ui_select_tmp('diagnose', 'character', 'rbDiseaseCharacter', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-4">
                            <label>Фаза</label>
                            {{ macros.ui_select_tmp('diagnose', 'phase', 'rbDiseasePhases', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-4">
                            <label>Стадия</label>
                            {{ macros.ui_select_tmp('diagnose', 'stage', 'rbDiseaseStage', 'diag_edit[$index]') }}
                        </div>
                    </fieldset>
                    <fieldset class="row">
                        <div class="form-group col-md-4">
                            <label>Диспансерное наблюдение</label>
                            {{ macros.ui_select_tmp('diagnose', 'dispanser', 'rbDispanser', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-4">
                            <label>Травма</label>
                            {{ macros.ui_select_tmp('diagnose', 'trauma_type', 'rbTraumaType', 'diag_edit[$index]') }}
                        </div>
                        <div class="form-group col-md-4">
                            <label>Группа здоровья</label>
                            {{ macros.ui_select_tmp('diagnose', 'health_group', 'rbHealthGroup', 'diag_edit[$index]') }}
                        </div>
                    </fieldset>
                    <fieldset class="row">
                        <div class="form-group col-md-12">
                            <label class="control-label" for="notes">Примечания</label>
                            <div class="form-control-static" ng-hide="diag_edit[$index]">[[ diagnose.notes ]]</div>
                            <textarea id="notes" class="form-control" ng-model="diag_edit[$index].notes" ng-show="diag_edit[$index]"></textarea>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<script>
WebMis20.controller('EventDiagnosesCtrl', ['$scope', 'RefBookService',
    function($scope, RefBookService) {
        $scope.rbDiagnosisType = RefBookService.get('rbDiagnosisType');
        $scope.rbDiseaseCharacter = RefBookService.get('rbDiseaseCharacter');
        $scope.rbDiseasePhases = RefBookService.get('rbDiseasePhases');
        $scope.rbDiseaseStage = RefBookService.get('rbDiseaseStage');
        $scope.rbHealthGroup = RefBookService.get('rbHealthGroup');
        $scope.rbDispanser = RefBookService.get('rbDispanser');
        $scope.rbTraumaType = RefBookService.get('rbTraumaType');

        $scope.diag_edit = [];
        $scope.diag_edit_start = function (index) {
            if (!$scope.diag_edit[index]) {
                $scope.diag_edit[index] = angular.extend({}, $scope.diagnoses[index])
            }
        };
        $scope.diag_edit_save = function (index) {
            if ($scope.diag_edit[index]) {
                $scope.diagnoses[index] = $scope.diag_edit[index];
                $scope.diagnoses[index]._dirty = true;
                $scope.diagnoses[index].client_id = $scope.event_info.client_id;
                $scope.diagnoses[index].event_id = $scope.event_info.id;
                $http.post('{{ url_for('.api_diagnosis_save') }}', $scope.diagnoses[index]).then(function () {
                    $scope.diag_edit[index] = undefined;
                    delete $scope.diagnoses[index]._first;
                });
            }
        };
        $scope.diag_edit_stop = function (index) {
            if ($scope.diag_edit[index]) {
                if ($scope.diag_edit[index]._first) {
                    $scope.diagnoses.splice(index, 1);
                }
                $scope.diag_edit[index] = undefined;
            }
        };
        $scope.diag_edit_new = function () {
            $scope.diagnoses.splice(0, 0, {
                person: $scope.Person.get({{ current_user.get_id() }}),
                _new: true,
                _first: true
            });
            $scope.diag_edit_start(0);
        };
        $scope.diag_edit_save_disabled = function (index) {
            var q = $scope.diag_edit[index];
            return !q.diagnosis_type;
        };

}]);
</script>