{% extends "schedule/base.html" %}
{% block main %}
<div ng-controller="ActionCtrl">
<legend xmlns="http://www.w3.org/1999/html">[[ action.action_type.name ]] - [[ action.client ]]</legend>
<div>
    <table class="table table-condensed">
        <thead>
        <tr>
            <th></th>
            <th ng-if="action_columns.assignable">Назначено</th>
            <th>Значение</th>
            <th ng-if="action_columns.unit">ед.изм</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="property in action.properties" ng-switch="property.type.type_name">
            <td class="action-property-name-field"><strong>[[ property.type.name ]]</strong></td>
            <td ng-if="action_columns.assignable"><input type="checkbox" ng-model="property.is_assigned" ng-if="property.type.is_assignable"></td>
            <td ng-switch-when="Text" ng-bind-html="property.value"></td>
            <td ng-switch-when="Html" ng-bind-html="property.value"></td>
            <td ng-switch-when="Constructor" ng-bind-html="property.value"></td>
            <td ng-switch-when="Жалобы" ng-bind-html="property.value"></td>
            <td ng-switch-default ng-bind="property.value"></td>
            <td ng-if="action_columns.unit">[[ property.type.unit.code ]]</td>
        </tr>
        </tbody>
    </table>
</div>
</div>
{% endblock %}

{% block modules_js %}
    <script>
    WebMis20.controller('ActionCtrl', ['$scope', '$http', function ($scope, $http) {
        $scope.params = aux.getQueryParams(location.search);
        $scope.action_id = $scope.params.action_id;
        $scope.action = null;
        $scope.action_columns = {};
        $scope.load = function () {
            $http.get('{{ url_for('.api_action_get') }}', {
                params: {
                    'action_id': $scope.action_id
                }
            }).success(function (data) {
                $scope.action = data.result;
                $scope.action_columns = {
                    assignable: false,
                    unit: false
                };
                angular.forEach(data.result.properties, function (item) {
                    $scope.action_columns.assignable |= item.type.is_assignable;
                    $scope.action_columns.unit |= item.type.unit;
                });
            })
        }
        $scope.load();
    }])
    </script>
{% endblock %}