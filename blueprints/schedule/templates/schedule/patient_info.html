{% extends 'schedule/base.html' %}

{% block title %}> {{ module_name }}{% endblock %}

{% block main %}
    <legend xmlns="http://www.w3.org/1999/html">Пациент</legend>
    <div ng-controller="ClientInfo">
{#        <form class="form-inline" role="form">#}
{#            <input class="form-control" type="text" ng-model="doctorInput" placeholder="ФИО врача">#}
{#        </form>#}
        <h3>Информация о пациенте </h3>
        <ul class="nav nav-tabs">
            <li ng-class="{active: tub_selected==1 }"><a href ng-click="tub_selected=1">Основная информация</a></li>
            <li ng-class="{active: tub_selected==2 }"><a href ng-click="tub_selected=2">Соц. статус</a></li>
            <li ng-class="{active: tub_selected==3 }"><a href ng-click="tub_selected=3">Особенности</a></li>
{#            <li ng-class="{active: tub_selected==4 }"><a href ng-click="tub_selected=3">Связи с др. пациентами</a></li>#}
{#            <li ng-class="{active: tub_selected==5 }"><a href ng-click="tub_selected=3">Связь с внешними сисемами</a></li>#}
{#            <li ng-class="{active: tub_selected==6 }"><a href ng-click="tub_selected=3">История документов</a></li>#}
        </ul>

        <div ng-show="tub_selected == 1">
            <table class="table table-condensed">
                <tbody>
                <tr ng-repeat="key in clientMainInfoCodeOrder" ng-if="clientDataItems[key]">
                    <td>[[ clientInfoCode2Name[key] ]]</td>
                    <td>[[ aux.format(clientDataItems, key) ]]</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div ng-show="tub_selected == 2">
            <table class="table table-condensed" ng-if="clientDataItems['socStatuses']">
                <thead>
                     <tr>
                        <th>Класс</th>
                        <th>Тип</th>
                        <th>Дата начала</th>
                        <th>Дата окончания</th>
                     </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="status in clientDataItems['socStatuses']">
                        <td>[[status.class]]</td>
                        <td>[[status.type]]</td>
                        <td>[[status.begDate]]</td>
                        <td>[[status.endDate]]</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div ng-show="tub_selected == 3">
            <table class="table table-condensed" ng-if="clientDataItems['bloodHistory']">
                <caption>Группа крови и резус-фактор</caption>
                <thead>
                     <tr>
                         <th>Группа крови</th>
                         <th>Дата установления</th>
                         <th>Врач</th>
                     </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="blood in clientDataItems['bloodHistory']">
                        <td>[[blood.bloodGroup]]</td>
                        <td>[[blood.bloodDate]]</td>
                        <td>[[blood.physician]]</td>
                    </tr>
                </tbody>
            </table>

            <table class="table table-condensed" ng-if="clientDataItems['allergies']">
                <caption>Аллергия</caption>
                <thead>
                     <tr>
                        <th>Наименование вещества</th>
                        <th>Степень</th>
                        <th>Дата установления</th>
                        <th>Примечание</th>
                     </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="allergy in clientDataItems['allergies']">
                        <td>[[allergy.nameSubstance]]</td>
                        <td>[[allergy.power]]</td>
                        <td>[[allergy.createDate]]</td>
                        <td>[[allergy.notes]]</td>
                    </tr>
                </tbody>
            </table>

            <table class="table table-condensed" ng-if="clientDataItems['intolerances']">
                <caption>Медикаметозная непереносимость</caption>
                <thead>
                     <tr>
                        <th>Наименование медикамента</th>
                        <th>Степень</th>
                        <th>Дата установления</th>
                        <th>Примечание</th>
                     </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="intolerance in clientDataItems['intolerances']">
                        <td>[[intolerance.nameMedicament]]</td>
                        <td>[[intolerance.power]]</td>
                        <td>[[intolerance.createDate]]</td>
                        <td>[[intolerance.notes]]</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div ng-show="tub_selected == 4">

        </div>
        <table class="table">
            <caption>Предварительные записи</caption>
            <thead>
            <tr>
                <th ng-repeat="key in recordColumnOrder" ng-bind="recordColumns[key]"></th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="record in records">
                <td ng-repeat="key in recordColumnOrder" ng-bind="aux.format(record, key)"></td>
            </tr>
            </tbody>
        </table>
{#        <pre>[[schedule|json]]</pre>#}
    </div>
{% endblock %}
{% block modules_js %}
    {{ super() }}
    <script type="text/javascript">
        WebMis20.controller('ClientInfo', ['$scope', '$http', function ($scope, $http) {
            $scope.max_tickets = 0;
            $scope.records = [];
            $scope.aux = aux;
            $scope.params = aux.getQueryParams(document.location.search);
            $scope.client_id = $scope.params.client_id;
            $scope.tub_selected = 1;
            var curDate = new Date();
            var curYear = curDate.getUTCFullYear();
            $scope.years = [curYear - 1, curYear, curYear + 1];
            $scope.year = curYear;
            $scope.clientInfoCode2Name = {
                'id': 'Код пациента',
                'birthDate': 'Дата рождения',
                'regAddress': 'Адрес регистрации',
                'liveAddress': 'Адрес проживания',
                'SNILS': 'СНИЛС',
                'nameText': 'ФИО',
                'sex': 'Пол',
                'document': 'Документ',
                'contact': 'Контакты',
                'voluntaryPolicy': 'Полис ДМС',
                'compulsoryPolicy': 'Полис ОМС'
            };
            $scope.clientMainInfoCodeOrder = ['id', 'nameText', 'birthDate', 'sex', 'regAddress', 'liveAddress', 'document', 'compulsoryPolicy', 'voluntaryPolicy', 'SNILS', 'contact'];
            $scope.recordColumns = {
                'mark': 'Отметка',
                'begDateTime': 'Дата и время приёма',
                'office': 'Кабинет',
                'person': 'Специалист',
                'createPerson': 'Записал',
                'note': 'Примечания'
            };
            $scope.recordColumnOrder = ['mark', 'begDateTime', 'office', 'person', 'createPerson', 'note'];
            $http.get(
                '{{ url_for('.api_patient') }}', {
                    params: {
                        'client_id': $scope.client_id
                    }
                }
            ).success(function (data) {
                $scope.clientDataItems = data.clientData;
                $scope.records = data.records;
            });

        }]);
    </script>
{% endblock %}
