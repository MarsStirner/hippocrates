{% macro html(popup=False, checkbox=False) %}
<div ng-controller="PersonTree" id="PersonTree">
    <span class="input-group" id="person-query-group">
        <span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
        <input id="person_query" class="form-control" type="text" ng-model="query" placeholder="Поиск врача"
               ng-change="compose()"{% if popup %} ng-focus="show_tree()"{% endif %}/>
        <span class="input-group-btn">
            <button type="button" class="btn btn-default" ng-click="clear()"><span class="glyphicon glyphicon-remove"></span></button>
        </span>
    </span>
    <div class="css-treeview well well-sm scrolled-tree{% if popup %} popup"  ng-mouseleave="hide_tree(){% endif %}">
        <ul>
            <li ng-repeat="spec_group in tree">
                <input class="group" type="checkbox" id="spec-[[spec_group.speciality.id]]" checked>
                <label class="group" for="spec-[[spec_group.speciality.id]]" ng-bind="spec_group.speciality.name" ></label>
                <ul>
                    <li ng-repeat="person in spec_group.persons">
                        {% if checkbox -%}
                        <input type="checkbox" id="doc-[[person.id]]" ng-model="person.checked"
                               ng-disabled="person.disabled" ng-change="selection_change(person)" class="leaf">
                        <label class="leaf" for="doc-[[person.id]]" ng-bind="person.name"></label>
                        {% else -%}
                        <a class="leaf" ng-bind="person.nameFull" ng-click="person_selected(person)"></a>
                        {% endif %}
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</div>
{% endmacro %}
<script type="text/javascript">
{% macro js() -%}
WebMis20.controller('PersonTree', ['$scope', '$http', function($scope, $http) {
    $scope.data = [];
    $scope.query = '';
    $scope.tree = [];
    $scope.data_selected = [];
    $scope.user_selected = [];
    {# Может, всё это грузить прямо здесь?#}
    $scope.reloadTree = function() {
        $http.get(
            '{{ url_for('.api_all_persons_tree') }}'
        ).success(function (data) {
            $scope.data = data.result;
            $scope.compose();
        })
    };
    $scope.reset = function () {
        $scope.query = '';
        $scope.user_selected = [];
        $scope.reloadTree();
    };
    $scope.compose = function () {
        $scope.tree = $scope.data.map(function (spec_group) {
            return {
                speciality: spec_group.speciality,
                persons: (spec_group.persons).filter(function (person) {
                    var words = $scope.query.split(' ');
                    return $scope.query == '' || words.filter(function (word) {
                        var data = [].concat(person.nameFull, [spec_group.speciality.name]);
                        return data.filter(function (namePart) {
                            return aux.startswith(namePart.toLocaleLowerCase(), word.toLocaleLowerCase())
                        }).length > 0;
                    }).length == words.length;
                }).map(function (person) {
                    return {
                        id: person.id,
                        name: person.name,
                        nameFull: person.nameFull.join(' '),
                        disabled: $.inArray(person.id, $scope.data_selected) !== -1,
                        checked: $.inArray(person.id, [].concat($scope.data_selected, $scope.user_selected)) !== -1
                    }
                })
            }
        }).filter(function (spec_group) {
            return spec_group.persons.length > 0;
        })
    };
    $scope.selection_change = function (person) {
        var user_selected = [];
        $scope.tree.map(function (spec_group) {
            spec_group.persons.filter(function (person) {
                return person.checked;
            }).map(function (person) {
                user_selected.push(person.id);
            })
        });
        $scope.user_selected = user_selected;
        $scope.$root.$broadcast('UserSelectionChanged', person, user_selected);
    };
    $scope.clear = function () {
        $scope.query = '';
        $scope.compose();
    };
    $scope.$on('DataSelectedChanged', function (event, data_selected) {
        $scope.data_selected = data_selected;
        $scope.compose();
    });
    $scope.$on('UserSelectionChanged', function (event) {
        $scope.compose();
    });
    $scope.$on('Reset', function () {
        $scope.reset();
    });
    var we = $('#PersonTree');
    var person_input = we.find('input#person_query');
    var person_query_group = we.find('#person-query-group');
    var person_tree_div = we.find('div.scrolled-tree.popup');
    $scope.show_tree = function () {
        $scope.compose();
        if (person_tree_div) {
            person_tree_div.width(person_query_group.width() - 20);
            person_tree_div.show();
        }
    };
    $scope.hide_tree = function () {
        if (person_tree_div) {
            person_tree_div.hide();
            person_input.blur();
        }
    };
    $scope.person_selected = function (person) {
        $scope.query = person.nameFull;
        $scope.hide_tree();
        $scope.$root.$broadcast('PersonSelected', person);
    };
    $scope.$on('ManuallySelectedPersonId', function (event, id) {
        var name = null;
        $scope.data.map(function (spec_group) {
            spec_group.map(function (person) {
                if (person.id == id) {
                    name = person.nameFull.join(' ')
                }
            })
        });
        $scope.query = name;
    });
    $scope.reset();
}]);
{% endmacro -%}
{# Это была попытка сделать дерево через фабрику, но, видимо, надо оставить контроллер #}
{% macro js_factory(controller, name='PersonTree') -%}
    {{ controller }}.factory('{{ name }}', ['$http', function ($http) {
        var Tree = function (config) {
            this.config = config;
            this.data = [];
            this.query = '';
            this.tree = [];
            this.data_selected = [];
            this.user_selected = [];
            this.reset();
        };
        Tree.prototype.reloadTree = function() {
            var tree = this;
            $http.get(
                '{{ url_for('.api_all_persons_tree') }}'
            ).success(function (data) {
                tree.data = data.result;
                tree.compose();
            })
        };
        Tree.prototype.reset = function () {
            this.query = '';
            this.user_selected = [];
            this.reloadTree();
        };
        Tree.prototype.compose = function () {
            var tree = this;
            this.tree = this.data.map(function (spec_group) {
                return {
                    speciality: spec_group.speciality,
                    persons: (spec_group.persons).filter(function (person) {
                        var words = tree.query.split(' ');
                        return tree.query == '' || words.filter(function (word) {
                            var data = [].concat(person.nameFull, [spec_group.speciality.name]);
                            return data.filter(function (namePart) {
                                return aux.startswith(namePart.toLocaleLowerCase(), word.toLocaleLowerCase())
                            }).length > 0;
                        }).length == words.length;
                    }).map(function (person) {
                        return {
                            id: person.id,
                            name: person.name,
                            nameFull: person.nameFull.join(' '),
                            disabled: $.inArray(person.id, tree.data_selected) !== -1,
                            checked: $.inArray(person.id, [].concat(tree.data_selected, tree.user_selected)) !== -1
                        }
                    })
                }
            }).filter(function (spec_group) {
                return spec_group.persons.length > 0;
            })
        };
        Tree.prototype.selection_change = function (person) {
            var user_selected = [];
            this.tree.map(function (spec_group) {
                spec_group.persons.filter(function (person) {
                    return person.checked;
                }).map(function (person) {
                    user_selected.push(person.id);
                })
            });
            this.user_selected = user_selected;
            this.$root.$broadcast('UserSelectionChanged', person, user_selected);
        };
        Tree.prototype.$on('DataSelectedChanged', function (event, data_selected) {
            this.data_selected = data_selected;
            this.compose();
        });
        Tree.prototype.$on('UserSelectionChanged', function (event) {
            this.compose();
        });
        Tree.prototype.$on('Reset', function () {
            this.reset();
        });
        Tree.prototype.show_tree = function () {
            var we = $('#PersonTree');
            var person_input = we.find('input#person_query');
            var person_tree_div = we.find('div.scrolled-tree');
            this.compose();
            person_tree_div.width(person_input.width());
            person_tree_div.show();
        };
        Tree.prototype.hide_tree = function () {
            var we = $('#{{ name }}');
            we.find('div.scrolled-tree').hide();
            we.find('input#person_query').blur();
        };
        Tree.prototype.person_selected = function (person) {
            this.query = person.nameFull;
            this.hide_tree();
            this.$root.$broadcast('PersonSelected', person);
        };
    };

}])
{%- endmacro %}
</script>