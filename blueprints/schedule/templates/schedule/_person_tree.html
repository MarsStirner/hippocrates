{% macro html_fixed() -%}
<div ng-controller="PersonTree" id="PersonTree">
    <input id="person_query" class="form-control" type="text" ng-model="query" placeholder="Поиск врача"
           ng-change="compose()"/>
    <div class="css-treeview well well-sm scrolled-tree">
        <ul>
            <li ng-repeat="spec_group in tree">
                <input class="group" type="checkbox" id="spec-[[spec_group.speciality.id]]" checked>
                <label class="group" for="spec-[[spec_group.speciality.id]]" ng-bind="spec_group.speciality.name" ></label>
                <ul>
                    <li ng-repeat="person in spec_group.persons">
                        <input type="checkbox" id="doc-[[person.id]]" ng-model="person.checked"
                               ng-disabled="person.disabled" ng-change="selection_change(person)" class="leaf">
                        <label class="leaf" for="doc-[[person.id]]" ng-bind="person.name"></label>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</div>
{%- endmacro %}
{% macro html_dropdown_select() -%}
<div ng-controller="PersonTree" id="PersonTree">
    <input id="person_query" class="form-control" type="text" ng-model="query" placeholder="Поиск врача"
           ng-change="compose()" ng-focus="show_tree()"/>
    <div class="css-treeview well well-sm scrolled-tree popup" ng-mouseleave="hide_tree()">
        <ul>
            <li ng-repeat="spec_group in tree">
                <input class="group" type="checkbox" id="spec-[[spec_group.speciality.id]]" checked>
                <label class="group" for="spec-[[spec_group.speciality.id]]" ng-bind="spec_group.speciality.name" ></label>
                <ul>
                    <li ng-repeat="person in spec_group.persons">
                        <a class="leaf" ng-bind="person.nameFull" ng-click="person_selected(person)"></a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</div>
{%- endmacro %}
<script type="text/javascript">
{% macro js() -%}
WebMis20.controller('PersonTree', ['$scope', '$http', function($scope, $http) {
    $scope.data = [];
    $scope.query = '';
    $scope.tree = [];
    $scope.data_selected = [];
    $scope.user_selected = [];
{#            // Может, всё это грузить прямо здесь?#}
    $scope.reloadTree = function() {
        $http.get(
            '{{ url_for('.api_all_persons_tree') }}'
        ).success(function (data) {
            $scope.data = data;
            $scope.compose();
        })
    };
    $scope.reset = function () {
        $scope.query = '';
        $scope.user_selected = [];
        $scope.reloadTree();
    };
    $scope.compose = function () {
        $scope.tree = $scope.data.map(function (spec_group) {
            return {
                speciality: spec_group.speciality,
                persons: (spec_group.persons).filter(function (person) {
                    var words = $scope.query.split(' ');
                    return $scope.query == '' || words.filter(function (word) {
                        var data = [].concat(person.nameFull, [spec_group.speciality.name]);
                        return data.filter(function (namePart) {
                            return aux.startswith(namePart.toLocaleLowerCase(), word.toLocaleLowerCase())
                        }).length > 0;
                    }).length == words.length;
                }).map(function (person) {
                    return {
                        id: person.id,
                        name: person.name,
                        nameFull: person.nameFull.join(' '),
                        disabled: $.inArray(person.id, $scope.data_selected) !== -1,
                        checked: $.inArray(person.id, [].concat($scope.data_selected, $scope.user_selected)) !== -1
                    }
                })
            }
        }).filter(function (spec_group) {
            return spec_group.persons.length > 0;
        })
    };
    $scope.selection_change = function (person) {
        var user_selected = [];
        $scope.tree.map(function (spec_group) {
            spec_group.persons.filter(function (person) {
                return person.checked;
            }).map(function (person) {
                user_selected.push(person.id);
            })
        });
        $scope.user_selected = user_selected;
        $scope.$root.$broadcast('UserSelectionChanged', person, user_selected);
    };
    $scope.$on('DataSelectedChanged', function (event, data_selected) {
        $scope.data_selected = data_selected;
        $scope.compose();
    });
    $scope.$on('UserSelectionChanged', function (event) {
        $scope.compose();
    });
    $scope.$on('Reset', function () {
        $scope.reset();
    });
    var we = $('#PersonTree');
    var person_input = we.find('input#person_query');
    var person_tree_div = we.find('div.scrolled-tree');
    $scope.show_tree = function () {
        $scope.compose();
        person_tree_div.width(person_input.width());
        person_tree_div.show();
    };
    $scope.hide_tree = function () {
        person_tree_div.hide();
        person_input.blur();
    };
    $scope.person_selected = function (person) {
        $scope.query = person.nameFull;
        $scope.hide_tree();
        $scope.$root.$broadcast('PersonSelected', person);
    };
    $scope.reset();
}]);
{% endmacro -%}
</script>