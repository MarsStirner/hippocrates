{% extends 'schedule/base.html' %}
{% import "schedule/_person_tree.html" as person_tree %}
{% block title %}> {{ module_name }}{% endblock %}

{% block main %}
    <legend xmlns="http://www.w3.org/1999/html"><h2>График врача</h2></legend>
    <div ng-controller="ScheduleMonthCtrl">
        <div class="row marginal">
            <div class="col-md-2">
                <select class="form-control" name="year" ng-model="year" ng-disabled="editing"
                        ng-options="y for y in years" ng-change="monthChanged()"></select>
            </div>
            <div class="col-md-2">
                <select class="form-control" name="month" ng-model="month" ng-disabled="editing"
                        ng-options="item.value as item.name for item in aux.months" ng-change="monthChanged()"></select>
            </div>
            <div class="col-md-8">
                {{ person_tree.html(popup=True) }}
            </div>
        </div>
        <div ng-show="person">
            <div class="btn-group">
                <button class="btn btn-primary" ng-click="start_editing()" ng-if="!editing">Редактировать</button>
                <button class="btn btn-success" ng-click="finish_editing()" ng-if="editing">Сохранить</button>
                <button class="btn btn-danger" ng-click="cancel_editing()" ng-if="editing">Отменить</button>
            </div>
            <button class="btn btn-warning" ng-click="fill_selection()" ng-if="editing" ng-disabled="selected_days.length == 0">Заполнить</button>
            <div class="btn-group" ng-if="editing">
                <button class="btn btn-primary disabled"><span class="glyphicon glyphicon-ok"></span></button>
                <button class="btn btn-primary" ng-click="select.odd()">Нечет дни</button>
                <button class="btn btn-primary" ng-click="select.invert()">Инверсия</button>
                <button class="btn btn-primary" ng-click="select.all()">Все</button>
                <button class="btn btn-primary" ng-click="select.none()">Снять</button>
            </div>
            <div ng-show="editing">
                <input type="checkbox" id="weekendCheckBox" ng-model="weekends_selectable" /><label for="weekendCheckBox">Выбирать выходные</label>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-condensed person-schedule">
                        <caption>[[ person.name ]]<small>, [[ person.speciality.name ]]</small></caption>
                        <thead>
                        <tr>
                            <th class="text-center" ng-if="editing">&raquo;</th>
                            <th class="text-center" ng-repeat="weekday in weekdays" ng-bind="weekday"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="week in week_data">
                            <td ng-if="editing" class="text-center">
                                <button class="btn btn-default" type="button" ng-click="select.week(week)">&raquo;</button>
                            </td>
                            <td ng-repeat="day in week">
                                <div class="panel small person-schedule-day"
                                     ng-if="!day.not_exists"
                                     ng-class="get_day_class(day, $index)"
                                     ng-click="select.day(day)">
                                    <div class="panel-heading">[[ day.date | asDate ]]
                                        <i class="pull-right glyphicon glyphicon-edit day-selectable" ng-if="day.busy" ng-click="free_up_day(day)"></i>
                                    </div>
                                    <ul class="panel-body list-group" ng-switch="person_schedule_day_switch(day)">
                                        <li class="list-group-item list-group-item-danger" ng-if="day.busy">Есть записи</li>

                                        <li class="list-group-item list-group-item-info" ng-repeat="sched in day.scheds">
                                            <p class="interval-title" ng-bind-html="getRecTypeText(sched.reception_type.code, true)"></p>
                                            <p><span class="glyphicon glyphicon-time"></span>
                                                <nobr>&nbsp;[[ (day.date + 'T' + sched.begTime) | asTime ]] - [[ (day.date + 'T' + sched.endTime) | asTime ]]</nobr></p>
                                            <p ng-if="sched.reception_type.code !== 'home'"><span class="glyphicon glyphicon-tag"></span>
                                                <nobr>&nbsp;Кабинет:&nbsp;[[ sched.office.code ]]</nobr></p>
                                        </li>

                                        <li class="list-group-item list-group-item-info" ng-switch-when="normal">
                                            <div class="text-right text-muted" ng-repeat="(rt_code, info) in day.info">
                                                <p class="interval-title" ng-if="show_day_info_title(day.info)" ng-bind-html="getRecTypeText(rt_code)"></p>
                                                <p><nobr>План:&nbsp;[[ info.planned ]]</nobr></p>
                                                <p><nobr>Сверх плана:&nbsp;[[ info.extra ]]</nobr></p>
                                                <p><nobr>Вне очереди:&nbsp;[[ info.CITO ]]</nobr></p>
                                            </div>
                                        </li>

                                        <li class="list-group-item" ng-switch-when="empty">Не&nbsp;заполнено</li>

                                        <li class="list-group-item list-group-item-danger" ng-switch-when="absent">Причина отсутствия:<br/>[[ day.roa.name ]]</li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
{#    <pre>Schedules: [[schedules | json]]</pre>#}
    </div>
{% endblock %}
{% block modules_js %}
    {{ super() }}

    <script type="text/ng-template" id="modal-DaysSetup.html">{% include "schedule/_daysetup.html" %}</script>
    <script type="text/ng-template" id="modal-DayFree.html">{% include "schedule/_day_free.html" %}</script>

    <script type="text/javascript">
        {{ person_tree.js() }}
    </script>
    <script src="{{ url_for('.static', filename='js/schedule_month.js', v=version) }}"></script>
{% endblock %}
