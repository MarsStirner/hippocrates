{% extends 'schedule/base.html' %}

{% block title %}> {{ module_name }}{% endblock %}

{% block main %}
    <legend xmlns="http://www.w3.org/1999/html">Пациенты</legend>
    <div ng-controller="ClientSearch">
        <form class="form-horizontal" role="form">
            <div class="input-group">
                <span class="input-group-addon glyphicon glyphicon-search"></span>
                <input id="search" class="form-control" type="text" ng-model="query"
                       placeholder="Введите код или фамилию или имя пациента">
                <span class="input-group-addon glyphicon glyphicon-remove" ng-click="query_clear()" style="cursor: pointer"></span>
            </div>
        </form>
        <table class="table table-condensed table-hover table-clickable">
            <caption>
                <span ng-if="results.length > 0">Результаты поиска</span>
                <span ng-if="results.length == 0 && query">Нет результатов</span>
            </caption>
            <thead ng-if="results.length > 0">
            <tr>
                <th ng-repeat="key in clientInfoCodeOrder" ng-bind="clientInfoCode2Name[key]"></th>
            </tr>
            </thead>
            <tbody ng-if="results.length > 0">
            <tr ng-repeat="result in results" ng-click="open_client(result.id)" style="cursor: pointer">
                <td ng-repeat="key in clientInfoCodeOrder" ng-bind="result | asAutoFormat:key"></td>
            </tr>
            </tbody>
        </table>
{#        <pre>[[schedule|json]]</pre>#}
    </div>
{% endblock %}
{% block modules_js %}
    {{ super() }}
    <script type="text/javascript">
        WebMis20.controller('ClientSearch', ['$scope', '$http', '$timeout', function ($scope, $http, $timeout) {
            $scope.aux = aux;
            $scope.params = aux.getQueryParams(document.location.search);
            $scope.clientInfoCode2Name = {
                'id': 'Код пациента',
                'birthDate': 'Дата рождения',
                'SNILS': 'СНИЛС',
                'nameText': 'ФИО',
                'sex': 'Пол',
                'document': 'Документ',
                'voluntaryPolicy': 'Полис ДМС',
                'compulsoryPolicy': 'Полис ОМС'
            };
            $scope.clientInfoCodeOrder = ['nameText', 'birthDate', 'sex', 'document', 'SNILS', 'compulsoryPolicy', 'voluntaryPolicy'];
            $scope.query = "";
            $scope.results = [];
            var _timeoutObjectForQuery;
            $scope.$watch('query', function (val) {
                if (_timeoutObjectForQuery) $timeout.cancel(_timeoutObjectForQuery);
                _timeoutObjectForQuery = $timeout(function () {
                    $scope.perform_search(val);
                }, 500)
            });
            $scope.perform_search = function (val) {
                if (!val) {
                    $scope.results = [];
                } else {
                    $http.get(
                        '{{ url_for('.api_search_clients') }}', {
                            params: {
                                q: val
                            }
                        }
                    ).success(function (data) {
                        $scope.results = data.sort(function compare(a, b) {
                            if (a.nameText < b.nameText) return -1;
                            else if (a.nameText > b.nameText) return 1;
                            return 0;
                        });
                    })
                }
            };
            $scope.open_client = function (client_id) {
                window.open('{{ url_for('.html_patient') }}?client_id=' + client_id, '_self');
            };
            $scope.query_clear = function () {
                $scope.query = '';
            }
        }]);
    </script>
{% endblock %}
